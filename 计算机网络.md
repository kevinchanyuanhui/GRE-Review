## 第1章 计算机网络体系结构

### 1.1 计算机网络概述

#### 1.1.2 计算机网络的组成

- **从组成部分看**

&emsp;&emsp;主要由**硬件、软件、协议**三大部分组成。

- **从工作方式上看**

&emsp;&emsp;可分为**边缘部分**和**核心部分**。边缘部分由**所有连接到因特网上、供用户直接使用的主机**组成，用来**通信**和**资源共享**；核心部分由**大量的网络和连接这些网络的路由**组成，它为边缘部分提供连通性和交换服务。

- **从功能上看**

&emsp;&emsp;可分**通信子网**和**资源子网**组成。

&emsp;&emsp;通信子网由**各种传输介质、通信设备和相应的网络协议**组成，它使网络具有数据传输、交换和存储的能力，**实现联网计算机之间的数据通信**；

&emsp;&emsp;资源子网是**实现资源共享的设备及其软件的集合**，向网络用户**提供其他计算机上的硬件资源、软件资源和数据资源服务**。

**【注】**世界上第一个计算机网络是ARPAnet



#### 1.1.6 计算机网络的性能指标

1. **带宽**：表示网络中的通信线路所能传输数据的能力，是数字信道所能传送的“最高数据率”的同义词，单位是比特/秒(b/s)。

2. **时延**：指数据(一个报文或分组)从网络(或链路)的一端传送到另一端所需要的总时间。它由4部分构成：**发送时延**、**传播时延**、处理时延和排队时延。（考试只要求前2个）

   - **发送时延**：是主机或路由器发送数据帧所需要的时间，也就是从发送数据帧的第一个比特算起，到该帧的最后一个比特发送完毕所需的时间，因此也称为**传输时延**。计算公式为

   $$
   发送时延 = 数据帧长度(b) / 信道带宽(b/s)
   $$

   - **传播时延**：电磁波在信道中传播一定距离需要花费的时间，即一个比特从链路的一端传播到另一端所需要的时间。计算公式为

   $$
   传播时延 = 信道长度(m) / 电磁波在信道上的传播速率(m/s)
   $$

   因此，数据在网络中经历的总时延就是上述2部分时延之和：
   $$
   总时延 = 发送时延+传播时延
   $$
   



### 1.2 计算机网络体系结构与参考模型

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2010-33</font>

#### 1.2.1 计算机网络分层结构

&emsp;&emsp;在计算机网络的分层结构中，第$n$层中的活动元素通常称为$n$层实体。不同机器上的同一层称为**对等层**。同一层实体称为**对等实体**。$n$层实体的服务为$n+1$层所利用。

&emsp;&emsp;在计算机网络体系结构的各个层次中，每个报文都分为两部分：一是**数据部分**，即**SDU**；二是**控制信息部分**，即**PCI**，它们共同组成**PDU**。

- **服务数据单元(SDU)**：为完成用户所需要的功能而应传送的数据。第$n$层的服务数据单元记为n-SDU。
- **协议控制信息(PCI)**：控制协议操作的信息。第$n$层的协议控制信息记为n-PCI。
- **协议数据单元(PDU)**：对等层次之间传送数据单位称为该层的PDU。**物理层的PDU称为比特，链路层的PDU称为帧，网络层的PDU称为分组，传输层的PDU称为报文**。

**【注】**n-SDU + n-PCI = n-PDU = (n-1)-SDU

<img src="./计算机网络/1.2.1-1.png" alt="1.2.1-1" style="zoom:80%;" />

具体地，层次结构的含义包括以下几个方面：

1）第n层的实体不仅要使用第n-1层的服务来实现自身定义的功能，还要向第n+1层提供本层的服务，该服务是第n层及以下面各层提供的服务总和。

2）最底层只提供服务，是整个层次结构的基础；中间各层既是下一层的服务使用者，又是上一层的服务供应者；最高层面向用户提供的服务。

3）上一层只能通过相邻层间的接口使用下一层的服务，而不能调用其它层次的服务；下一层所提供服务的实现细节对上一层透明。

4）两台主机通信时，对等层在逻辑上有一条直接通道，表现为不经过下层就把信息传送到对方。



#### 1.2.3 ISO/OSI参考模型和TCP/IP模型

##### 1. OSI参考模型

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2009-33,2013-33,2014-33,2017-33</font>

&emsp;&emsp;OSI有7层，自下而上依次为物理层、数据链路层、网络层、传输层、会话层、表示层、应用层。**低三层称为通信子网**，它是为了联网而附加的通信设备，完成数据传输功能；高三层称为**资源子网**，它相当于计算机系统，完成数据的处理等功能。

<img src="./计算机网络/1.2.3-1.png" alt="1.2.3-1" style="zoom:80%;" />

下面介绍各层的功能

**（1）物理层**

&emsp;&emsp;传输单位是**比特**，任务是透明的传输比特流，功能是在物理媒体上为数据端设备透明地传输原始比特流。

&emsp;&emsp;物理层协议称为**物理层接口标准**或**物理层规程**。物理的标准接口有**EIA-232C**、**EIA/TIA RS-449**、**CCITT的X.21**等

**【注】**传输信息所利用的一些物理媒介，如**双绞线**、**光缆**、**无线信道**等，并不在物理层协议之内而在物理层协议下面。因此，**有人称物理媒介当作第0层**。

**（2）数据链路层(Data Link Layer)**

&emsp;&emsp;传输单位是**帧**，任务是**将网络层传来的IP数据组装成帧**。数据链路层的功能可以概括为**成帧**、**差错控制**、**流量控制**和**传输管理**等。

&emsp;&emsp;典型的数据链路层协议有**SDLC、HDLC、PPP、STP**和帧中继等。

**【注】**数据链路层不具有**拥塞控制**的功能。

**（3）网络层(Network Layer)**

&emsp;&emsp;传输单位是**数据报**，关心的是通信子网的运行控制，主要任务是**把网络层的协议数据单元(分组)从源端传到目的端**，为分组交换网上的不同主机提供通信服务。关键问题是对分组进行路由选择，并实现**流量控制**、**拥塞控制**、**差错控制**和**网际互联**等功能。

&emsp;&emsp;网络层的协议有**IP、IPX、ICMP、IGMP、ARP、RARP和OSPF**等。

**（4）传输层(Transport Layer)**

&emsp;&emsp;传输单位是**报文段(TCP)**或**用户数据报(UDP)**，传输层负责主机**两个进程**之间的通信，功能是为**端到端**连接提供可靠的传输服务，为端到端连接提供**流量控制**、**差错控制**、**服务质量**、**数据传输管理**等服务。

&emsp;&emsp;传输层协议有**TCP和UDP**。

**【注】**数据链路层提供的是点到点的通信，传输层提供的是端到端的通信。因为一台主机可同时运行多个进程，因而传输层具有**复用**和**分用**的功能。

**（5）会话层(Session Layer)**

&emsp;&emsp;会话层**允许不同主机上的各个进程之间进行会话**。会话层利用传输层提供的	端到端的服务，向表示层提供它的增值服务。

&emsp;&emsp;会话层负责管理主机间的会话进程，包括**建立**、**管理**及**终止**进程间的会话。可以使用校验点使通信会话在通信失效时从校验点继续恢复通信，实现数据同步。

**（6）表示层(Presetation Layer)**

&emsp;&emsp;主要处理在两个通信系统中交换信息的表示方式。表示层采用抽象的标准方法定义数据结构来使得不同表示方法的数据和信息之间能相互交换。

**（7）应用层(Application Layer)**

&emsp;&emsp;是用户与网络的界面。典型的协议有文件传输的FTP、用于电子邮件的SMTP、用于万维网的HTTP等。



##### 2. TCP/IP模型

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2011-33</font>

&emsp;&emsp;ARPA在研究ARPnet时提出了TCP/IP模型，模型从低到高依次为**网络层接口(对应OSI参考模型中的物理层和数据链路层)**、**网际层**、**传输层**和**应用层(对应OSI参考模型中的会话层、表示层和应用层)**。

**（1）网络层接口**

&emsp;&emsp;它表示与物理网络的接口，但实际上TCP/IP本身并未真正描述这一部分，只是指出主机必须使用某种协议与网络连接，以便在其上传递IP分组。具体的物理网络既可以是各种类型的局域网，如以太网、令牌环网、令牌总线网等，也可以是诸如电话网、SDH、X.25、帧中继和ATM等公共网络数据。**网络接口层的作用是从主机或结点接收IP分组，并把他们发生到指定的物理网络上**。

**（2）网际层(主机-主机)**

&emsp;&emsp;它是TCP/IP体系结构的关键部分。它和OSI网络层在功能上非常相似。网际层**将分组发往任何网络，并为之独立地选择合适的路由**，但**它不保证各个分组有序到达，各个分组有序交付由高层负责**。网际层定义了标准的分组格式和协议，即IP。

**【注】**网际层提供的是**无连接不可靠的数据报服务**。

**（3）传输层(应用-应用或进程-进程)**

&emsp;&emsp;使得**发送端和目的端主机上的对等实体进行会话**。主要使用以下两种协议

- **传输控制协议(TCP)**：它是面向连接的，数据传输的单位是报文段，能够提供可靠的交付。
- **用户数据报协议(UDP)**：它是无连接的，数据传输单位是用户数据报，不能保证提供可靠的交付，只能提供“尽最大努力交付”。

（4）**应用层(用户-用户)**

&emsp;&emsp;包含所有高层协议，如**虚拟终端协议(Telnet)、文件传输协议(FTP)、域名解析服务(DNS)、电子邮件协议(SMTP)和超文本传输协议(HTTP)**。

<img src="./计算机网络/1.2.3-2.png" alt="1.2.3-2" style="zoom:80%;" />

##### 3. OSI参考模型与TCP/IP参考模型的比较 

- **相同点**

1）**二者都采取分成的体系结构**，将庞大且复杂的问题划分为若干较容易处理的、范围较小的问题，而且分层的功能也大致相似。

2）二者都是**基于独立的协议栈**的概念。

3）二者都**可以解决异构网络的互联**，实现世界上不同厂家生产的计算机之间的通信。

- **不同点**

<img src="./计算机网络/1.2.3-3.png" alt="1.2.3-3" style="zoom:80%;" />





## 第2章 物理层

### 2.1 通信基础

#### 2.1.1 基本概念



2. **信源、信道与信宿**

**（1）信源**：是产生和发送数据的源头。

**（2）信宿**：是接收数据的端点。

**（3）信道**：是信号的传输媒介。

信道上的信号有**基带信号**和**宽带信号**之分。

- 基带信号将数字1和0直接用两种不同的电压表示，然后送到数字信道上传输(称为基带传输)；
- 宽带信号将基带信号进行调制后形成频分复用模拟信号，然后送到模拟信道上传输(称为宽带传输)。

从通信双方信息的交互来看，可分为三种基本方式：

- **单工通信**：只有一个方向的通信而没有反方向的交互，仅需要一条信道。例如**无线电广播、电视广播**就是这种类型。
- **半双工通信**：通信双方都可以发送或接收信息，但任何一方都不能同时发送和接收信息，此时需要两条信道。
- **全双工通信**：通信双方可以同时发送和接收信息，也需要两条信道。

<img src="./计算机网络/2.1.1-1.png" alt="2.1.1-1" style="zoom:90%;" />



3. **速率、波特与带宽**

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2011-34</font>

- **速率**

&emsp;&emsp;速率也称数据率，指的是数据的传输速率，表示单位内传输的数据量。也可以用**码元传输速率**和**信息传输速率**表示。

**（1）码元传输速率**：又称为码元速率、波形速率等，表示**单位时间内数字通信系统所传传输的码元个数(也可以是脉冲个数或信号变化的次数)**，单位是**波特(Baud)**。
$$
1波特 =数字通信系统每秒传输一个码元
$$
**（2）信息传输率**：又称为信息速率、比特率等，它表示**单位时间内数字通信系统传输的二进制码元个数(即比特数)**，单位是**比特/秒(b/s)**。

> 若一个码元携带$n$比特的信息量(有$2^n$个有效离散值)，则$M$波特率的码元传输速率所对应的信息传输速率为$Mn$比特/秒。

**（3）带宽**：是指信号具有的频带宽度，单位是赫兹(Hz)。常表示网络线路所能传输数据的能力。



#### 2.1.2 奈奎斯特定理与香农定理

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2009-34,2014-35,2016-34,2017-34</font>

1. **奈奎斯特定理**

$$
理想低通信下的极限数据传输率=2W\log_2 V \quad(单位:b/s)
$$

- $W:$理想低通信道的带宽
- $V:$表示每个码元离散电平的数目

2. **香农定理**

$$
信道的极限数据传输率=W\log_2(1+S/N) \quad(单位:b/s)
$$

- $W$：信道的带宽
- $S/N$：$信噪比=10\log_{10}S/N\quad(单位:dB)$

**【注】**信道的传输速率实际上就是信号的发送速率，而**调制速率也会直接限制数据的传输速率**，但**它与信号的传播速率无关**。

#### 2.1.3 编码与调制

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2013-34,2015-34</font>

&emsp;&emsp;数据无论是数字还是模拟，为了传输的目的都必须转变成信号。

- **调制**：把数据变换为**模拟信号**的过程。

- **编码**：把数据变换为**数字信号**的过程。

1. **数字数据编码为数字信号**

&emsp;&emsp;数字数据编码用于**基带传输**中，即在不改变数字数据信号频率的情况下，直接传输数字信号。

**（1）非零编码(NRZ)**

&emsp;&emsp;用两个电压来代表两个二进制数字，如**低电平表示0，高电平表示1**；或者相反。特点是容易实现，但没有检错功能，而且也无法判断一个码元的开始与结束，以致于**难以保持同步**。

**（2）曼彻斯特编码**

&emsp;&emsp;将一个码元分为两个相等的间隔，**前一个间隔为高电平后一个间隔为低电平表示码元1；码元0相反**。特点是在每个码元的中间出现电平跳变，**位中间的跳变既作为时钟信号(可用于同步)，又作为数据信号**，但它所占的频带宽度是原始基带的两倍。

【注】**以太网使用的编码方式就是曼彻斯特编码**。

**（3）差分曼彻斯特编码**

&emsp;&emsp;常用于**局域网传输**，其规则是：**若码元为1，则前半个码元的电平与上一码元的后半个码元的电平相同；码元为0，则情况相反**。该编码的特点是每个码元中间都有一次电平的跳转，可以**实现自同步**，**抗干扰性较好**。

<img src="./计算机网络/2.1.3-1.png" alt="2.1.3-1" style="zoom:80%;" />

2. **数字数据调制为模拟信号**

&emsp;&emsp;数字数据调制技术在发送端将数字信号转换为模拟信号，而在接收端将模拟信号还原为数字信号，分别对应于调制解调器中的**调制**和**解调**过程。调制方法如下：

<img src="./计算机网络/2.1.3-2.png" alt="2.1.3-1" style="zoom:80%;" />

&emsp;&emsp;2ASK中用载波**有幅度和无幅度**分别表示数字数据的“1”和“0”；2FSK中用两种**不同的频率**分别表示数字数据“1”和“0”；2PSK中用**相位0和相位 &pi;** 分别表示数字数据“1”和“0”，是一种绝对调相方式。

<img src="./计算机网络/2.1.3-3.png" alt="2.1.3-3" style="zoom:80%;" />

3. **模拟数据编码为数字信号**

&emsp;&emsp;这种编码方式最典型的例子是常用于对**音频信号进行编码的脉码调制(PCM)**。它主要包括三个步骤：**采用、量化、编码**。

4. **模拟数据调制为模拟信号**

&emsp;&emsp;**频分复用(FDM)**。



#### 2.1.4 电路交换、报文交换、分组交换

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2010-34,2013-35</font>

1. **电路交换**

&emsp;&emsp;在进行数据传输前，两个结点之间必须先**建立一条专用(双方独占)的物理通信路径**(由通信双方之间的交换设备和链路逐段连接而成)，该路径可能经过多个中间结点。**这一路径在整个传输期间一直被独占，直到通信结束后才被释放**。

&emsp;&emsp;电路交换技术分三个阶段：**连接建立**、**数据传输**和**连接释放**。

- **优点**

<img src="./计算机网络/2.1.4-1.png" alt="2.1.4-1" style="zoom:90%;" />

- **缺点**

<img src="./计算机网络/2.1.4-2.png" alt="2.1.4-2" style="zoom:90%;" />

**【注】**：电路建立后，除源结点和目的结点外，电路上的任何结点都采取“直通方式”接收数据和发送数据，即**不会存在存储转发所耗费的时间**。

2. **报文交换**

&emsp;&emsp;数据交换的单位是**报文**，报文携带有**目标地址**和**源地址**等信息。报文交换在交换结点采用的是**存储转发**的传输方式。

- **优点**

<img src="./计算机网络/2.1.4-3.png" alt="2.1.4-3" style="zoom:90%;" />

<img src="./计算机网络/2.1.4-4.png" alt="2.1.4-4" style="zoom:90%;" />

- **缺点**

<img src="./计算机网络/2.1.4-5.png" alt="2.1.4-5" style="zoom:90%;" />

**【注】**：报文交换主要使用在早期的电报通信网中，现在较少使用，通常被先进的分组交换方式所取代。因为报文经过的中间结点的接收、存储和转发时间较长也不固定，因此**不能用于实时的应用环境(如语音、视频等)**

3. **分组交换**

&emsp;&emsp;同报文交换一样，分组交换也采用**存储转发**方式，但解决了报文交换中大报文传输的问题。分组交换**限制了每次传送数据块大小的上限，把大的数据块划分为合理的小数据块**，再加上一些必要的**控制信息(如源地址、目的地址和编号信息等)**，构成分组(Packet)。网络结点是根据控制信息把分组送到下一结点，下一结点接收分组后，暂时保存并排队等待传输，然后根据分组的控制信息选择它下一个结点，直到到达目的结点。

- **优点**

<img src="./计算机网络/2.1.4-6.png" alt="2.1.4-6" style="zoom:90%;" />

- **缺点**

<img src="./计算机网络/2.1.4-7.png" alt="2.1.4-7" style="zoom:90%;" />

4. **三种交换方式的比较**

1）要传送的**数据量很大且传送时间远大于呼叫时间时**，采用**电路交换**比较合适。

2）**端到端**的通路由多段链路组成时，采用**分组交换**传送数据比较合适。

3）从提高整个网络的通信利用率上看，**报文交换和分组交换**优于电路交换，其中分组交换比报文交换时延更小，尤其适合于计算机之间的突发式数据通信。

<img src="./计算机网络/2.1.4-8.png" alt="2.1.4-8" style="zoom:90%;" />

#### 2.1.5 数据报与虚电路

&emsp;&emsp;**分组交换**根据其通信子网向端点系统提供的服务，还可进一步分为**面向连接的虚电路方式**和**面向无连接的数据报方式**。这两种方式都由**网络层**提供。要注意数据报方式和虚电路方式是分组交换的两种方式。

1. **数据报**

&emsp;&emsp;作为通信子网的端系统发送一个报文时，在端系统中实现的高层协议先**把报文拆成若干带有序号的数据单元**，并在**网络层**上**加上地址等控制信息后形成数据报文组(即网络层PDU)**。中间结点存储分组很短的一段时间，找到最佳路由后，尽快转发每个分组。**不同的分组可以走不同的路径，也可以按不同的顺序到达目的地**。

- **例子(主机A向主机B发送分组)**

<img src="./计算机网络/2.1.5-1.png" alt="2.1.5-1" style="zoom:80%;" />

<img src="./计算机网络/2.1.5-2.png" alt="2.1.5-2" style="zoom:80%;" />

**【注】**因为采用存储转发技术的资源是共享的，所以主机A在发送分组时，主机B也可以同时向其他主机发送分组。

- **特点**

<img src="./计算机网络/2.1.5-3.png" alt="2.1.5-3" style="zoom:80%;" />



2. **虚电路**

&emsp;&emsp;虚电路方式试图将**数据报方式与电路交换方式结合起来**，充分发挥两种方式的优点，以达到最佳数据交换效果。**在分组发送之前，要求在发送方和接收方建立一条逻辑上相连的虚电路，并且连接一旦建立，就固定了虚电路所对应的物理路径**。与电路交换类似，整个通信过程分为三个阶段：**虚电路建立**、**数据传输**与**虚电路释放**。

&emsp;&emsp;在虚电路方式中，端系统**每次建立虚电路时，选择一个未用过的虚电路号分配给该虚电路**，以区别于本系统中的其它虚电路号。在传送数据时，每个数据分组不仅要有**分组号**、**校验和**等控制信息，还要有它通过的**虚电路号**。在虚电路网络中的每个结点上都**维持了一张虚电路表**，表中的每项纪录了一个打开的虚电路的信息，包括在**接收链路和发送链路上的虚电路号**、**前一个结点和下一个结点标识**。**数据的传输是双向进行的**，上述信息是在虚电路的建立过程中确定的。

- **虚电路方式的工作原理**

<img src="./计算机网络/2.1.5-4.png" alt="2.1.5-4" style="zoom:80%;" />

<img src="./计算机网络/2.1.5-7.png" alt="2.1.5-7" style="zoom:80%;" />

- **特点**

<img src="./计算机网络/2.1.5-5.png" alt="2.1.5-5" style="zoom:80%;" />

<img src="./计算机网络/2.1.5-6.png" alt="2.1.5-6" style="zoom:80%;" />

**【注】**虚电路之所以“虚”是因为这条**电路不是专用的**，每个结点到其他结点到其他结点之间的链路可能同时有若干虚电路通过，也可能同时与多个结点之间建立虚电路。

- **数据报服务 VS 虚电路服务**

<img src="./计算机网络/2.1.5-8.png" alt="2.1.5-8" style="zoom:80%;" />



### 2.2 传输介质

#### 2.2.1 双绞线、同轴电缆、光纤与无线传输介质

&emsp;&emsp;传输介质也称为传输媒体，它是发送设备和接收设备之间的物理通路。

1. **双绞线**

&emsp;&emsp;双绞线价格便宜，是最常用的传输介质之一，**在局域网和传统电话中普遍使用**。双绞线的带宽取决于**铜线的粗细**和**传输的距离**。模拟传输和数字传输都可以使用双绞线，其通信距离几千米到十千米。**距离太远时，对于模拟传输，要用放大器放大衰减信号；对于数字传输信号，要用中继器将失真的信号整形**。

2. **同轴电缆**

&emsp;&emsp;按特性阻抗的不同，通常将同轴电缆分为两类：

**1）50Ω同轴电缆**：用于传送基带数字信号，又称基带同轴电缆，它**在局域网中应用广泛**；

**2）75Ω同轴电缆**：用于传送宽带信号，又称为宽带同轴电缆，主要**用于有线电视系统**。

&emsp;&emsp;由于外导体屏蔽层的作用，同轴电缆**具有较好的抗干扰性能**，被广泛用于传输较高速率的数据，其传输距离更远，但价格较双绞线昂贵。

**【注】**屏蔽指的是**减少电磁波干扰辐射**

3. **光纤**

&emsp;&emsp;光纤通信就是利用光导纤维(简称光纤)传递光脉冲来进行通信。光的频率为$10^8$MZ，因此光纤系统的带宽极大。

**1）多模光纤**：光源为**发光二极管**，适用于**近距离传输**。它传输光信号的原理是**全反射**。

**2）单模光纤**：光源为**激光二极管**，适用于**远距离传输**。

4. **无线电传输介质**

**（1）无线电波**

&emsp;&emsp;无线电波具有很强的穿透力，可以**传输很长距离**。应用于无线手机通讯、计算机网络中的无线局域网(WLAN)等。因为无线电波使信号所有方向传播，**大大简化了通信连接**。

**（2）微波、红外线、激光**

&emsp;&emsp;它们是目前**高宽带**的无线通信技术。它们都需要发送方和接收方之间存在一条**视线通路**，有很强的方向性，都沿直线传播，有时统称这三者为**视线介质**。

&emsp;&emsp;**微波通信的频率较高，频段范围也很宽，因而通信信道的容量很大**。微波通信的信号在地面的传输距离有限，超过一定距离后就要用中继站来接力。卫星通信利用地球同步卫星作为中继来转发微波信号，可以克服地面微波通信距离的限制。

#### 2.2.2 物理层接口的特性

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2012-34</font>

&emsp;&emsp;物理层的主要任务是可以描述为确定与传输媒体的接口有关的一些特性：

<img src="./计算机网络/2.2.2-1.png" alt="2.2.2-1" style="zoom:80%;" />

<img src="./计算机网络/2.2.2-2.png" alt="2.2.2-2" style="zoom:79%;" />



### 2.3 物理层设备

#### 2.3.1 中继器

&emsp;&emsp;中继器又称**转发器**，**主要功能**是**将信号整形并放大再转发出去**，以消除信号经过一长段电缆后，因为噪声或其它原因而造成的失真和衰弱，使信号的波形和强度达到所需的要求，进而扩大网络传输的距离。其**原理**是**信号再生**(非简单地将衰弱的信号放大)。中继器有两个端口，数据从一个端口输入，再从另一个端口发出。**端口仅作用于信号的电气部分**，而不管数据中是否有错误数据或者不适合网段的数据。

- **特点**

1）中继器是局域网环境下用来扩大网络规模的最简单。最廉价的互联网设备。

2）**使用中继器的几个网段仍然是一个局域网**。

3）一般情况下，中继器的两端连接的是相同的媒体，但有的中继器也可以完成不同的媒体转接工作。

4）由于中继器工作在物理层，因此它**不能连接两个具有不同速率的局域网**。

5）**中继器两端的网络部分是网段，而不是子网**。中继器若出现故障，对相邻两个网段的工作都产生影响。

**【注1】**在采用粗同轴电缆的**10BASE5**以太网规范中，互相串联的**中继器个数不能超过4个**，而且**用4个中继器串联的5段通信介质中只有3段可以直接挂计算机**。(5-4-3原则)

**【注2】**

<img src="./计算机网络/2.3.1-1.png" alt="2.3.1-1" style="zoom:80%;" />

#### 2.3.2 集线器(Hub)

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2016-33/35</font>

&emsp;&emsp;**集线器实质上是一个多端口的中继器**，它也工作在物理层。当Hub工作时，一个端口接收到数据信号后，由于信号在从端口到Hub的传输过程中已有衰减，所以Hub便将该信号进行整形放大，使之再生(恢复)到发送时的状态，紧接着转发到其它所有(除输入端口)处于工作状态的端口。**如果同时有两个或多个端口输入，那么输出时会发生冲突，致使这些数据都无效**。从Hub的工作方式可以看出，**它在网络中只起到信号放大和转发作用，目的是扩大网络的传输范围，而不具备信号的定向传送能力，即信号传输的方向是固定的，是一个标准的共享设备**。

**【注】**集线器连接的网络在拓扑结构上属于星形。

- **特点**

1）Hub主要使用**双绞线**组建共享网络，是从服务器连接到桌面的最经济方案。

2）**在交换网络中，Hub直接与交换机相连**，将交换机端口的数据送到桌面上。

3）使用Hub组网灵活，它把所有结点的通信集中在以其为中点的结点上，对结点相连的工作站进行集中管理，不让出问题的工作站影响整个网络的正常运行，并且用户的加入和退出也很自由。

4）**由Hub组成的网络是共享网络**，但**逻辑上仍是一个总线网**。

5）Hub的**每个端口连接的网络部分是同一个网络的不同网段**，同时Hub也只能在半双工状态下工作，网络的吞吐率因而受到限制。

**【注】物理层设备既不可以隔离冲突域，也不可以隔离广播域**。

<img src="./计算机网络/2.3.2-1.png" alt="2.3.2-1" style="zoom:80%;" />



## 第3章 数据链路层

### 3.1 数据链路层的功能

#### 3.1.1 为网络层提供服务

**1）无确认的无连接服务**：适用于实时通信或误码率较低的通信信道，如**以太网**。

**2）有确认的无连接服务**：适用于误码率较高的通信信道，如**无线通信**。

**3）有确认面向连接服务**：一般分为三个过程：**建立数据链接、传输帧、释放数据链路**。适用于通信要求(可靠性、实时性)较高的场合。

**【注】有连接就一定要有确认**，即不存在无确认的面向连接服务。



#### 3.1.2 链路管理

&emsp;&emsp;**数据链路层连接的建立、维持和释放过程称为链路管理**，它主要用于**面向连接**的服务。



#### 3.1.3 帧定界、帧同步与透明传输

&emsp;&emsp;两个工作站之间传输信息时，必须将网络层的分组封装成帧，以帧的格式进行传输。**将一段数据的前后部分分别添加首部和尾部，就构成了帧**。首部和尾部中含有很多控制信息，它们的一个重要作用是确定帧的界限，即帧定界。而**帧同步**是指**接收方应能从接收到的二进制比特流中区分出帧的起始与终止**。

&emsp;&emsp;在HDLC通信规程中，用**标识符F(01111110)**来标识帧的开始和结束。

<img src="./计算机网络/3.1.3-1.png" alt="3.1.3-1" style="zoom:80%;" />

**透明传输**：不管传输数据是什么样的比特组合，都能在链路上传送。



#### 3.1.4 流量控制

&emsp;&emsp;指的是**由于发送方的发送能力大于接收方的接收能力，要限制发送方的发送速率**，以防止前面来不及接收的帧被“淹没”，造成帧的丢失而出错。

&emsp;&emsp;**许多高层协议也有流量控制**。对于数据链路层来说，控制的是两结点之间的数据链路上的流量，而对于传输层来说，控制的是从源端点到目的端之间的流量。



#### 3.1.5 差错控制

&emsp;&emsp;**用以使发送方确定接收方是否正确接收到由其发送的数据的方法**成为你差错控制。这些错误可分为**位错**和**帧错**。

- **位错**：某些位出现了差错，通常采用**循环冗余校验(CRC)**。通常采用**自动重传请求(Automatic Repeat reQuest, ARQ)**方式来重传出错的帧。
- **帧错**：指帧的丢失、重复或失序等错误。在数据链路层引入定时器和编码机制，能保证每一帧都能有且仅有一次正确地交付给目的的结点。



### 3.2 组帧

&emsp;&emsp;数据链路层之所以要把比特组合成帧为单位传输，是为了在出错时只重发出错的帧，而不必重发全部数据，从而提高效率。组帧主要解决**帧定界**、**帧同步**、**透明传输**等问题。通常有以下4种方法实现组帧。

#### 3.2.1 字符计数法

&emsp;&emsp;字符计数法是指**在帧头部使用一个计数字段来标明帧内字符数**。

**特点**：如果计数字段出错，即失去了帧边界划分的依据，那么接受方就无法判断所传输帧的结束位置和下一帧的开始位，收发双方将失去同步，从而造成灾难性后果。

<img src="./计算机网络/3.2.1-1.png" alt="3.2.1-1" style="zoom:80%;" />

#### 3.2.2 字符填充的首尾定界符法

&emsp;&emsp;字符填充法使用一些特定的字符来定界一帧的**开始(DLE STX)**与**结束(DLE ETX)**。**为了使信息位中出现的特殊字符不被误判为帧的首尾定界符，可以在特殊字符前填充一个转义字符(DLE)来加以区分**，以实现透明传输。

<img src="./计算机网络/3.2.2-1.png" alt="3.2.2-1" style="zoom:80%;" />

#### 3.2.3 比特填充的首尾标志法

&emsp;&emsp;比特填充法**允许数据帧包含任意个数的比特，也允许每个字符的编码包含任意个数的比特**。它适用一个特定的比特模式，即01111110来标志一帧的开始和结束。**为了不使信息位中出现的比特流01111110被误判为帧的首尾标志，发送方的数据链路层在信息位中遇到5个连续“1”时，将自动在其后插入一个“0”**；而接收方做该过程的逆操作，即每收到5个连续的“1”时，自动删除后面紧跟的“0”，以恢复原信息。

<img src="./计算机网络/3.2.3-1.png" alt="3.2.3-1" style="zoom:80%;" />

#### 3.2.4 违规编码法

&emsp;&emsp;在物理层进行比特编码时，通常采用违规编码法。例如：曼彻斯特方法将数据比特“1”编码成“高-低”电平对，将数据比特“0”编码成“低-高”电平对，而“高-高”电平对和“低-低”电平对在数据比特中是违归的。可以借助这些违规编码序列来界定帧的起始和终止。**局域网IEEE 802标准就采用了这种方法**。

**特点**：违规编码法**不需要采用任何填充技术**，便能实现数据传输的透明性，但它只使用于采用冗余编码的特殊编码环境。

**【注】**组帧的方法通常采用比特填充和违规编码法。



### 3.3 差错控制

&emsp;&emsp;传输中的差错是由噪声引起的。噪声有两大类：一类是**信道所固有的、持续存在的随机热噪声**；另一类是**由外界特定的短暂原因所造成的冲击噪声**。前者可以通过**提高信噪比**来减少或避免干扰，而后者不可能靠提高信号幅度来避免干扰造成的差错，是产生差错的重要原因。

&emsp;&emsp;通常利用**编码技术**进行差错控制，主要有两类：**自动重传请求(Automatic Retransmission reQust, ARQ)**和**前向纠错(Forward Error Correction, FEC)**。在ARQ方式中，接收端检测出差错时，就设法通知发送端重发，直到接收到正确的码字为止。**在FEC方式中，接收端不但能发现差错，而且能确定二进制数码的错误位置，从而加以纠正**。因此，差错控制又分为**检错编码(Error-Detecting Code)**和**纠错编码(Error-Correcting Code)**。

#### 3.3.1 检错编码

1. **奇偶校验码**

&emsp;&emsp;它由**n-1位信息元**和**1位校验元**组成。

**1）奇校验码**：信息元中1的个数为奇数，则校验元为1，否则为0。

**2）偶校验码**：信息元中1的个数为偶数，则校验元为1，否则为0。

2. **循环冗余码(CRC)**

&emsp;&emsp;假设一个帧有m位，其对应的多项式为M(x)，则计算冗余码的步骤如下：

**1）加0**。假设G(x)的阶为r，则帧的低位段加上r个0。

**2）模2除**。利用模2除法，用G(x)对应的数据串去除1）中计算出的数据串，**得到的余数即为冗余码(共r位，前面的0不可以省略)**

**【注1】**多项式以2位模运算，**加法不进位，减法不错位**，它刚好是异或操作。

**【注2】**使用多项式编码时，发送端和接收端必须预先商定一个生成多项式。

- **例子**

<img src="./计算机网络/3.3.1-1.png" alt="3.3.1-1" style="zoom:80%;" />

<img src="./计算机网络/3.3.1-2.png" alt="3.3.1-2" style="zoom:80%;" />

#### 3.3.2 纠错编码

参考《组成原理》2.1.5-2 海明校验码。





###3.4 流量控制与可靠传输机制

#### 3.4.1 流量控制、可靠传输与滑动窗口机制

&emsp;&emsp;流量控制涉及对链路上的帧的发送速率的控制，以使接收仿有足够的缓存空间来接收每个帧。常用的方法有**停止等待协议**和**滑动窗口协议**。

##### 1. 停止等待流量控制基本原理

&emsp;&emsp;发送方每发送一帧，都要等待接收方的应答信号，之后才能发送下一帧；接收方每接收一帧，都要反馈一个应答信号，表示可接收下一帧，如果接收方不反馈应答信号，那么发送方必须一直等待。**每次只允许发送一帧**，然后就陷入等待接收方确认信息的过程，因而传输效率很低。



##### 2. 滑动窗口流量控制基本原理

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2015-35</font>

&emsp;&emsp;在任意时刻，发送方都维持**一组连续的允许发送的帧的序号**，称为**发送窗口**；同时接收方也维持**一组连续的允许接收帧的序号**，称为**接收窗口**。

&emsp;&emsp;发送窗口用来对发送方进行流量控制，**发送窗口$W_T$代表在还未收到对方确认情况下发送方最多还可以发送几个数据帧**；

<img src="./计算机网络/3.4.1-1.png" alt="3.4.1-1" style="zoom:85%;" />

&emsp;&emsp;接收窗口是为了控制可以接收哪些数据帧和不可以接收哪些帧。**在接收方，只有收到的数据帧序号落入接收窗口内时才允许数据帧收下，否则一律将其丢弃**。

<img src="./计算机网络/3.4.1-2.png" alt="3.4.1-2" style="zoom:85%;" />

**【注1】**开始发送帧到接收第一个确认帧为止
$$
T = 第一个帧的传输\&传播时延+确认帧的传输\&传播时延
$$
如果题目说不考虑确认帧的开销，那么上述式子中没有确认帧的传输时延。

**【注2】**对于窗口大小为n的滑动窗口，最多可以有n-1帧发送但没有确认。



- **滑动窗口的重要特性**

（1）只有接收窗口向前滑动(同时接收方发送了确认帧)时，发送窗口才可能(只有发送方收到确认帧后才一定)向前移动。

（2）比较各种协议发送窗口和接收窗口的差别：

| 协议               | 发送窗口 | 接收窗口 |
| ------------------ | -------- | -------- |
| 停止等待协议       | =1       | =1       |
| 后退$N$帧协议(GBN) | >1       | =1       |
| 选择重传协议(SR)   | >1       | >1       |

（3）**接收窗口为1时，可以保证帧的有序接收**。

（4）数据链路层的滑动窗口协议中，窗口的大小在传输的过程中是固定的。



##### 3. 可靠传输机制

数据链路层的可靠传输通常使用**确认**和**超时**重传两种机制来完成。

- **确认**：是一种无数据控制的控制帧，这种控制帧使得接收方可以让发送方知道哪些内容被正确接收。有些情况下为了提高传输效率，将确认稍带在一个回复帧中，称为**捎带确认**。
- **超时**：是指发送方在发送某个数据帧后就开启一个计数器，在一定时间内如果没有得到发送数据帧的确认帧，那么就重新发送该数据帧，直到发送成功为止。

&emsp;&emsp;自动重传请求(quto Repeat reQuest, ARQ)是通信中用于处理信道所带来的差错的方法之一。传统自动重传请求分为三种：**①停止-等待ARQ ② 后退N帧ARQ ③ 选择性重传ARQ**

&emsp;&emsp;后两种是滑动窗口技术与请求重发技术的结合，由于窗口尺寸开导足够大时，帧在线路上可以连续地流动，因此又称为**连续ARQ协议**。

#### 3.4.2 单帧滑动窗口与停止-等待协议

&emsp;&emsp;在停止-等待协议中，源站发送单个帧后必须等待确认，在目的站的回答到达源站前，源站不能发送其它的数据帧。

&emsp;&emsp;在停止等待协议中，除数据帧丢失外，还可能出现以下两种差错：

**1）到达目的站的帧可能遭到破坏**。

**解决办法**：设置计数器

**2）数据帧正确而确认帧被破坏**。

- **停止等待协议算法的实现步骤**

**1）发送结点**

<img src="./计算机网络/3.4.2-1.png" alt="3.4.2-1" style="zoom:80%;" />

<img src="./计算机网络/3.4.2-2.png" alt="3.4.2-2" style="zoom:80%;" />

**2）接收结点**

<img src="./计算机网络/3.4.2-3.png" alt="3.4.2-3" style="zoom:80%;" />

**【注】**在停止-等待协议中，若连续出现相同发送序号的数据帧，表明发送端进行了超时重传；若出现相同序号的确认帧时，表明接收端收到了重复帧。





#### 3.4.3 多帧滑动窗口和后退N帧协议(GBN)

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2009-35,2012-36,2014-36</font>

<font color='#0099ff' size=5 face="黑体">大题：</font><font color='#FF0000' size=4 face="黑体">2017-47</font>

&emsp;&emsp;在后退N帧式ARQ中，发送方无须在收到上一帧的ACK后才能开始发送下一帧，而是可以连续发送帧。当接收方检测出失序的信息帧后，要求发送方重发最后一个正确接收的信息帧之后的所有未被确认的帧；或者当发送方发送了N个帧后，若发现该N个帧的前一个帧在计时器超时后仍未返回确认信息，则该帧被判断为出错或丢失，此时发送方不得不重传该出错帧及随后的N个帧。换句话说，**接收方只允许按顺序接收帧**。

&emsp;&emsp;源站每发送完一帧就要为该帧设置超时计数器。为了减少开销，GBN协议还规定接收端不一定每收到一确认帧就必须立即回发一个帧进行确认，而可以在连续收到好几个正确的数据帧后，才对最后一个数据帧发确认信息。ACKn表示对第n号帧的确认，表示已经正确接到第n号帧及以前的所有帧。

&emsp;&emsp;后退N帧协议的**接收窗口为1**，可以保证按序接收数据帧。若采用$n$比特对帧编号，则其发送窗口的尺寸$W_T$应满足$1 \le W_T \le 2^n-1 $。**若发送窗口的尺寸大于$2^n-1$，则会造成接收方无法辨别新帧和旧帧**。

<img src="./计算机网络/3.4.3-1.png" alt="3.4.3-1" style="zoom:80%;" />

**【注】**
$$
信道利用率 = \frac{传输n个帧的时间}{传输1个帧的周期} \le 1
$$

$$
\begin{aligned}
&传输1个帧的周期 \\
=& 发送端的发送时延 + 发送端的传播时延 \\
+&接收端的发送时延+接收端的传播时延
\end{aligned}
$$

$$
\mathrm{RTT} = 发送端的传播时延 + 接收端的传播时延
$$

若题目说明忽略确认帧的长度，则忽略接收端的发送时延。



#### 3.4.4 多帧滑动窗口与选择重传协议(SR)

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2011-35</font>

&emsp;&emsp;为进一步提高信道的利用率，可设法只传出差错的数据帧或计时器超时的数据帧，但此时必须加大接收窗口，以便先收下发送序号不连续但仍处在接收窗口的那些数据帧。等到所缺序号的数据帧收到后再一并送交主机。这就是选择重传ARQ协议。

&emsp;&emsp;在选择重传协议中，每个发送缓冲区对应一个计时器，当计时器超时时，缓冲区的帧就会重传。另外，该协议使用了比上述其他协议更有效的处理策略，即**一旦接收方怀疑帧出错，会发一个否定帧NAK给发送方，要求发送方对NAK指定的帧进行重传**。

<img src="./计算机网络/3.4.4-1.png" alt="3.4.4-1" style="zoom:85%;" />

&emsp;&emsp;若采用n比特对帧编号，有
$$
接收窗口W_R+发送窗口W_T \le 2^n
$$
&emsp;&emsp;而接收窗口$W_R \le$ 发送窗口$W_T$，故$W_R \le 2^{n-1}$，接收窗口为最大值时，$W_{R\max} = W_{T\max}=2^{n-1}$。

**【注】**：一般情况下，$W_R=W_T$，**SR不要求帧有序到达**。

- **信道的效率(信道利用率)**

&emsp;&emsp;信道效率是对发送方而言的，是指发送方在一个发送周期时间内，有效地发送数据所需要的时间占整个发送周期的比率。

**例子：**

<img src="./计算机网络/3.4.4-2.png" alt="3.4.4-2" style="zoom:90%;" />

- **信道吞吐率**

$$
信道吞吐率 = 信道利用率 \times 发送方的发送速率
$$



### 3.5 介质访问控制

&emsp;&emsp;介质访问控制所要完成的任务是，为使用介质的每个结点隔离来自同一信道上其他结点所传送的信号，以协调活动结点的传输。用来决定**广播信道**中信道分配的协议属于数据链路层的一个子层，称为**介质访问控制(Medium Access Control, MAC)子层**。

&emsp;&emsp;常见的介质访问控制有**信道划分介质访问控制**、**随机访问介质访问控制**和**轮询访问介质访问控制**。

#### 3.5.1 信道划分介质访问控制

&emsp;&emsp;信道划分介质访问控制使用介质的每个设备与来自同一通道上的其它设备的通信隔离开来，把时域和频域资源合理地分配给网络上的设备。

- **多路复用技术**

&emsp;&emsp;当传输介质的带宽超过传输单个信号所需的带宽时，人们就通过在一条介质上同时携带多个信号的方法来提高传输系统的效率，这就是多路复用。多路复用技术**把多个信号组合在一条物理信道上进行传输，使多个计算机或终端设备共享信道资源，提高了信道的利用率**。

&emsp;&emsp;采用多路复用技术可以把多个输入通道的信息整合到一个复用通道中，在接收端收到的信息分离出来并传送到对应的输出通道。

<img src="./计算机网络/3.5.1-1.png" alt="3.5.1-1" style="zoom:90%;" />

信道的划分介质访问控制有如下4种：

1. **频分多路复用(FDM)**

&emsp;&emsp;频分多路复用是一种将多路基带信号调制到不同的频率载波上，再叠加形成一个复合信号的多路复用技术。在物理信道的可用带宽超过单个原始信号所需的情况下，可将该物理信道的总带宽分割成若干与传输单个信号带宽相同的子信道，每个子信道传输一种信号。

- **特点**：充分利用了传输介质的带宽，系统效率较高，容易实现。

2. **时分多路复用(TDM)**

&emsp;&emsp;时分多路复用是将一个物理信道按时间划分成若干时间片，轮流地分配给多个信号使用，每个时间片由复用的一个信号占用。这样，利用每个信号在时间上的交叉，就可以在一条物理信道上传输多个信号。

&emsp;&emsp;**统计时分多路复用(STDM，又称异步时分多路复用)**是TDM的一种改进，它采用STDM帧。它具有动态分配时隙的功能。

**【注】**TDM适合于传输数字信号，FDM适合于传输模拟信号。

- **例子**：线路的传输速率为8000b/s，4个用户的平均速率为2000b/s，采用TDM方式时，每个用户的最高速率为2000b/s，采用STDM方式时，每个用户的最高速率可达8000b/s。

3. **波分多路复用(WDM)**

&emsp;&emsp;**波分多路复用即光的频分复用**，它在一根光纤中传输多种不同波长(频率)的光信号，由于波长(频率)不同，各路光信号互不干扰，最后再用波长分解复用器将各路波长分解出来，由于光谱处于频谱的最高频段，有很高的带宽，因而可实现多路的波分复用。

4. **码分多路复用(CDM)**

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2014-37</font>

&emsp;&emsp;码分复用是**采用不同的编码**来区分各路原始信号的一种复用方法。**与FDM和TDM不同，它既共享信道的频率，又共享时间**。

&emsp;&emsp;**码分多址(Code Division Multiple Access, CSDA)**是码分复用的一种方式，其原理是**每比特时间被划分成m个更短的时间槽**，称为**码片**，**通常情况下每比特有64或128个码片**。每个站点被指定一个唯一的m位代码或码片序列。**发送1时，站点发送码片序列；发送0时，站点发送码片序列的反码**。当两个或多个站点同时发送时，各路数据在信道中线性相加。从信道中分离出各路信号，要求各个站点的码片序列相互正交。

- **例子**

<img src="./计算机网络/3.5.1-2.png" alt="3.5.1-2" style="zoom:90%;" />

<img src="./计算机网络/3.5.1-3.png" alt="3.5.1-3" style="zoom:82%;" />

<img src="./计算机网络/3.5.1-4.png" alt="3.5.1-4" style="zoom:80%;" />

- **特点**：具有频谱利用率高、抗干扰能力强、保密性强、语音指令好等优点，还可以减少投资和降低运行成本，主要用于无线通信系统，特别是移动通信系统。



#### 3.5.2 随机访问介质访问控制

&emsp;&emsp;在随机访问协议中，不采用集中控制方式解决发送信息的次序问题，所有用户根据自己的意愿随机地发送信息，**占信道的全部速率**。它们的核心思想是：**胜利者通过争用获得信道，从而获得信息的发送权**。

##### 1. ALOHA协议

**（1）纯ALOHA协议**

- **基本思想**

&emsp;&emsp;当网络中的任何一个站点需要发送数据时，可以不进行任何检测就发送数据。如果在一段时间内未收到确认，那么该站点就认为在传输过程中发生了冲突。发送站点需要等待一段时间再发送数据。

<img src="./计算机网络/3.5.2-7.png" alt="3.5.2-7" style="zoom:80%;" />

**（2）时隙ALOHA协议**

- **基本思想**

&emsp;&emsp;把所有各站在时间上同步起来，并将时间划分为一段等长的时隙(Slot)，规定只能在每个时隙开始时才能发送一个帧。从而避免了用户发送数据的随意性，减少了数据产生冲突的可能性，提高了信道的利用率。

<img src="./计算机网络/3.5.2-8.png" alt="3.5.2-8" style="zoom:80%;" />

##### 2. CSMA

&emsp;&emsp;若每个站点在发送前都先侦听一下公用信道，发现信道空闲后再发送，则会大大降低冲突的可能性，从而提高信道的利用率，**载波侦听多路访问(Carrier Sense Multiple Access, CSMA)协议**依据的正是这个思想。

**（1）1-坚持CSMA**

- **基本思想**

&emsp;&emsp;一个结点要发送数据时，首先帧听信道，如果信道空闲，那么立即发送数据；如果信道忙碌，那么等待，同时**继续侦听直到信道空闲**；如果发送冲突，那么随机等待一段时间，再重新开始侦听信道。

**“1-坚持”的含义**：侦听到信道忙后，继续坚持侦听信道；侦听到信道空闲后，发送帧的概率为1，即立即发送数据。

**【注】**传播延迟对1-坚持CSMA协议的性能影响比较大。

**（2）非坚持CSMA**

- **基本思想**

&emsp;&emsp;一个结点要发送数据时，首先侦听信道：如果信道空闲，那么立即发送数据；如果信道忙，那么**放弃侦听**，等待一个随机的时间后再重复上述过程。

**（3）p-坚持CSMA**

&emsp;&emsp;p-坚持CSMA用于**时分信道**，当一个结点要发送数据时，首先侦听信道：如果信道忙，那么等待下一个时隙再侦听；如果信道空闲，那么以概率p发送数据，以概率1-p推迟到下一个时隙。

<img src="./计算机网络/3.5.2-9.png" alt="3.5.2-9" style="zoom:80%;" />





##### 3. CSMA/CD协议

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2009-37,2013-36,2015-36</font>

<font color='#0099ff' size=5 face="黑体">大题：</font><font color='#FF0000' size=4 face="黑体">2010-47</font>

&emsp;&emsp;**载波侦听多路访问/碰撞检测(CSMA/CD)协议**是CSMA协议的改进方案，适用于**总线形网络**或**半双工网络**环境。

- **“载波帧听”**

&emsp;&emsp;指**发送前先侦听**，即每个站在发送数据之前都要检测一下总线上是否有其他站点正在发送数据，若有则暂停发送数据，等待信道空闲时再发送。

- **“碰撞检测”**

&emsp;&emsp;就是**边发送边侦听**，即适配器边发送数据边检测信道上的信号电压变化情况，以便判断自己在发送数据时其他站点是否也在发送数据。

- **工作流程——“先听后发，边听边发(区别于CSMA)，冲突停发，随机重发”**

<img src="./计算机网络/3.5.2-1.png" alt="3.5.2-1" style="zoom:90%;" />

- **最小帧的计算公式**

$$
最小帧长 = 2\times 总线传播时延 \times 数据传输率
$$

> 例如，以太网规定取51.2us为争用期的长度。对于10Mb/s的以太网，在争用期内可以发送512bit，即64B。在以太网发送数据时，如果64B未发生冲突，那么后续数据也不会发生冲突(表示已经成功占信道)。换句话说，如果发生冲突，那么一定在前64B。因此，以太网规定的最短帧为64B。

- **二进制指数退避算法**

<img src="./计算机网络/3.5.2-2.png" alt="3.5.2-2" style="zoom:90%;" />

**【注】**争用期：信号在最远两个端点之间往返传输的时间。

例子：

<img src="./计算机网络/3.5.2-3.png" alt="3.5.2-3" style="zoom:90%;" />

**【注1】**CSMA/CD协议适用于有线网络，而CSMA/CA适用于无线网络。

**【注2】**CSMA/CD的碰撞窗口 = 2倍传播时延



##### 4. CSMA/CA协议

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2011-36,2013-36</font>

&emsp;&emsp;CSMA/CD协议已成功用于使用有线连接的局域网，但在**无线局域网环境**下，却不能简单地搬用CSMA/CD协议，特别是碰撞检测部分。主要有两个原因：

<img src="./计算机网络/3.5.2-4.png" alt="3.5.2-4" style="zoom:80%;" />

&emsp;&emsp;802.11标准定义了**广泛用于无线局域网**的CSMA/CA协议，它对CSMA/CD进行了修改，将碰撞检测改为**碰撞避免(Collision Avoidance, CA)**。“碰撞避免”并不是指协议可以完全避免碰撞，而是指协议的设计要尽量降低碰撞发送的概率。

&emsp;&emsp;CSMA/CA采用二进制指数避免算法。它还使用**预约信道、ACK帧、RES/CTS帧**等三种机制来实现碰撞避免：

<img src="./计算机网络/3.5.2-5.png" alt="3.5.2-5" style="zoom:80%;" />

- **CSMA/CD与CSMA/CA的主要区别**

<img src="./计算机网络/3.5.2-6.png" alt="3.5.2-6" style="zoom:80%;" />

**总结**：CSMA/CA协议的基本思想是在发送数据时**广播通知其他结点**，让其他结点在某段时间内不要发送数据，以免出现碰撞。CSMA/CD协议的基本思想是发送前侦听，边发送边侦听，一旦出现碰撞马上停止发送。

#### 3.5.3 轮询访问介质访问控制：令牌传递协议

&emsp;&emsp;在轮询访问中，用户不能随机发送信息，而要通过一个集中控制的监控站，以循环方式轮询每个结点，再决定信道的分配。当某个结点使用信道时，其他结点都不能使用信道。典型的轮询访问介质访问控制协议是**令牌传递协议**，它主要用在**令牌局域网**中。

- **令牌传递协议**

<img src="./计算机网络/3.5.3-1.png" alt="3.5.3-1" style="zoom:80%;" />

**【注】**轮询介质访问控制非常适合**负载很高的广播通信**，所谓负载很高的信道，是指多个结点在同一时刻发送数据概率很大的信道。轮询介质访问控制**既不共享时间，也不共享空间**。

**【注】**令牌网络是不存在冲突的。



### 3.6 局域网

#### 3.6.1 局域网的基本概念和体系结构

&emsp;&emsp;**局域网(Local Area Net, LAN)**是指在一个较小的地理范围(如一所学校)内，将计算机、外部设备和数据库系统等通过双绞线、同轴电缆等连接介质相互连接起来，组成资源和信息共享的计算机互联网络。

- **局域网的特点**

<img src="./计算机网络/3.6.1-1.png" alt="3.6.1-1" style="zoom:80%;" />

- **决定局域网特性的因素**

  1）拓扑结构	2）传输介质	3）介质访问

其中最重要的是介质访问控制方式，它决定着局域网的技术特性。

- **常见的局域网拓扑结构**

  1）星形结构	2）环形结构	3）总线形结构	4）星形和总线形结合的复合型结构

- **局域网使用的传输介质**

  1）双绞线	2）铜缆	3）光纤

其中双绞线为主流的传输介质。

- **局域网的介质访问控制方法**

  1）CSMA/CD	2）令牌总线	3）令牌环

- **三种特殊的局域网拓扑实现如下**

**1）以太网(目前使用最广的局域网)**。逻辑拓扑是总线形结构，物理拓扑是星形或拓展星形结构。

**2）令牌环(Token Ring, IEEE 802.5)**。逻辑拓扑是环形结构，物理拓扑是星形结构。

**3）FDDI(光纤分布数字接口，IEEE 802.8)**。逻辑拓扑是环形结构，物理拓扑是双环结构。

- **IEEE 802局域网参考模型**

&emsp;&emsp;IEEE 802标准定义的局域网参考模型只对应于OSI参考模型的**数据链路层**和**物理层**，并将数据链路层拆分为两个子层：**逻辑链路控制(LLC)子层**和**媒体接入控制(MAC)子层**。

**1）LLC子层**：它与传输层媒体无关，向网络层提供**无确认无连接**、**面向连接**、**带确认无连接**、**高速传送**4种不同的连接服务类型。

**2）MAC子层**：它向上屏蔽物理层访问的各种差异，提供对物理层的统一接口，主要功能有**组帧、拆卸帧、比特传输差错检测、透明传输**。



#### 3.6.2 以太网与IEEE 802.3

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2012-35,2016-36</font>

&emsp;&emsp;严格来说，以太网应当是指符合**DIX Ethernet V2标准**的局域网，但DIX Ethernet V2标准与IEEE 802.3标准只有很小的差别，因此**通常将802.3局域网简称为以太网**。

&emsp;&emsp;以太网采用两项措施简化通信：采用**无连接工作方式**，不对发送的数据帧编号，也不要求接收方发送确认，即以太网尽最大努力交付数据，提供的是不可靠服务，对于差错的纠正则由高层完成。

**【注】**以太网的MAC协议提供**无连接不可靠**的服务。

##### 1. 以太网的传输介质与网卡

- **以太网的传输介质**

&emsp;&emsp;以太网常用的传输介质有4种：**粗缆、细缆、双绞线**和**光纤**。

<img src="./计算机网络/3.6.2-1.png" alt="3.6.2-1" style="zoom:80%;" />

**【注1】**10BASE-T 非屏蔽双绞线以太网拓扑结构为星形网，**星形网中心为集线器**，但使用集线器的以太网在逻辑上仍然是一个总线网，属于一个冲突域。

**【注2】**100BASE-T对应线路的传输速率为100Mb/s

- **网卡**

&emsp;&emsp;网卡是局域网中连接计算机和传输介质的接口，不仅能实现与局域网传输介质之间的物理连接和电信号匹配，还涉及帧的发送与接收、帧的封装与拆封、介质访问控制、数据编码与解码及数据缓存功能等。

&emsp;&emsp;全世界的**每块网卡在出厂时都有一个唯一的代码**，称为介质访问控制(MAC)地址。**数据链路层设备(网桥、交换机等)都使用各个网卡的MAC地址**。

【注】**网卡工作在物理层**。

##### 2. 以太网的MAC帧

<font color='#0099ff' size=5 face="黑体">大题：</font><font color='#FF0000' size=4 face="黑体">2011-47</font>

&emsp;&emsp;每块网络适配器(网卡)都有一个地址，称为MAC地址，也称为物理地址；**MAC地址长6字节**，一般用由连字符(或冒号)分隔的6个十六进制数表示，如02-60-8c-e4-b1-21。高24位为厂商代码，低24位为厂商自行分配的网卡序列号。

&emsp;&emsp;由于**总线上使用的是广播通信**，因此网卡从网络上每收到一个MAC帧，首先要用硬件检查MAC帧中的MAC地址。如果是发往本站的帧，那么收下，否则丢弃。

&emsp;&emsp;以太网MAC帧格式有两种标准：**DIX Ethernet V2标准**和**IEEE 802.3标准**。DIX Ethernet V2标准的MAC帧格式如图

<img src="./计算机网络/3.6.2-2.png" alt="3.6.2-2" style="zoom:80%;" />

- **前导码**

<img src="./计算机网络/3.6.2-3.png" alt="3.6.2-3" style="zoom:80%;" />

【注】**MAC帧不需要帧结束符**，因为以太网在传送帧时，各帧之间必须有一定的间隙。因此，接收端只要找到帧开始定界符，其后面连续到达的比特流就都属于同一个MAC帧。但是不要误以为以太网MAC帧不需要尾部，在**数据链路层上，帧既需要加首部，也要加尾部**。

- **地址**：通常用**6个字节**(48Bit)地址(MAC地址)
- **类型**：2字节，指出数据域中携带的数据应交给哪个协议实现处理。
- **数据**：**46~1500字节**，包含高层的协议消息。**由于CSMA/CD算法的限制，以太网帧必须满足最小长度要求64字节**，数据较少时必须加以填充(0~46字节)。

- **填充**：0~46字节，当帧太短时填充帧，使之达到64字节的最小长度。
- **校验码(FCS)**：4字节，**校验范围**从**目的地址到数据段的末尾**，算法采用32位循环冗余码(CRC)，不但需要校验MAC帧的数据部分，还要校验目的地址、源地址和类型字段，但**不校验前导码**。



- **802.3帧格式和DIX以太帧格式的区别**

<img src="./计算机网络/3.6.2-4.png" alt="3.6.2-4" style="zoom:80%;" />

**【注】**以太网有效数据为1500字节，即以太网帧的数据部分**(考试常识)**。



##### 3. 高速以太网

&emsp;&emsp;**速率达到或超过100Mb/s的以太网称为高速以太网**。

<img src="./计算机网络/3.6.2-5.png" alt="3.6.2-5" style="zoom:80%;" />

#### 3.6.3 IEEE 802.11

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2017-35</font>

&emsp;&emsp;IEEE 802.11是**无线局域网**的一系列协议标准，包括802.11a和802.11b等。它们制定了MAC层协议。**运行在多个物理层标准上**。

&emsp;&emsp;802.11的MAC层采用**CSMA/CA协议**进行介质访问控制。

【注】**在无线局域网中，即使在发送过程中发生了碰撞，也要把整个帧发送完毕**。而在有线局域网中，发生冲突则结点立即停止发送数据。

&emsp;&emsp;无线局域网可分为两大类：**固定基础设施无线局域网**和无**固定基础设施无线局域网自组织网络**。

1. **有固定基础设施无线局域网**

&emsp;&emsp;802.11标准规定无线局域网的最小构件是**基本服务集(Basic Service Set, BSS)**。一个基本服务集包括**一个基站**和**若干移动站**。**所有的站在本BSS内部可以直接通信，但与本BSS外的站通信时都要通过本BSS的基站**。基本服务集中的基站也称为**接入点(Access Point, AP)**，其作用和网桥相似。

&emsp;&emsp;一个基本服务集可以是孤立的，也可以通过接入点(AP)连接到一个**主干分配系统(Distribution System, DS)**，然后再接入另一个基本服务集，构成**扩展的服务集(Extend Service Set, ESS)**，扩展服务集(ESS)还可以通过称为**门桥(Portal)**的设备为**无线用户提供到非802.11无线局域网(如到有线连接的因特网)**的接入。**门桥的作用相当于一个网桥**。基本服务集和扩展服务集如图：

<img src="./计算机网络/3.6.3-1.png" alt="3.6.3-1" style="zoom:80%;" />

&emsp;&emsp;移动站A从某个基本服务集漫游到另一个基本服务集时，仍然能保持与另一个移动站B进行通信。

2. **无固定基础设施无线局域网自组织网络**

&emsp;&emsp;自组织网络**没有上述基本服务集中的接入点(AP)**，而是**由一些平等状态移动站相互通信组成的临时网络**。各结点之间地位平等，**中间结点都为转发结点，这些结点都具有路由器功能**。

&emsp;&emsp;移动自组织网通常是这样构成的：一些可移动设备发现在它们附近还有其它移动设备，并且要求和其他移动设备通信。它和移动IP并不相同。**移动IP技术使漫游的主机可用多种方法连接到因特网，其核心网络功能仍然是基于固定互联网中一直在使用的各种路由选择协议**。而移动自组织网络是把移动性扩展到无线领域中的自治系统，**具有自己特定的路由选择协议，并且可以不和因特网连接**。

<img src="./计算机网络/3.6.3-2.png" alt="3.6.3-2" style="zoom:80%;" />

**【注】**802.11数据帧类型

<img src="./计算机网络/3.6.3-3.png" alt="3.6.3-3" style="zoom:80%;" />



### 3.7 广域网

#### 3.7.1 广域网的基本概念

&emsp;&emsp;广域网通常是指**覆盖范围很广(远超过一个城市的范围)的长距离网络**，它是**因特网的核心部分**，其任务是长距离运送主机所发送的数据。

&emsp;&emsp;**广域网不等于互联网**，互联网可以连接不同类型的网络(既可以连接局域网，又可以连接广域网)，通常是使用路由器来连接。广域网由一些**结点交换机(不是路由器)**及连接这些交换机的链路组成。

<img src="./计算机网络/3.7-1.png" alt="3.7-1" style="zoom:80%;" />

- **广域网和局域网的区别和联系**

<img src="./计算机网络/3.7-2.png" alt="3.7-2" style="zoom:90%;" />

**【注1】**广域网的覆盖范围较广、结点较多，为了保证可靠性和可扩展性，其拓扑结构通常采用**网状形**

**【注2】**广域网的通信子网主要使用**分组交换技术**。

PPP协议和HDLC协议是目前最常用的两种广域网数据链路层控制协议。

#### 3.7.2 PPP协议

&emsp;&emsp;PPP(Point-to-Point Protocol)是使用**串行线路通信**的**面向字节**的协议，该协议应用在直接连接两个结点的链路上。设计的目的主要是用来通过拨号或专线方式建立点对点连接发送数据，使其成为各种主机、网桥和路由器之间简单连接的一种共同解决方案。

&emsp;&emsp;PPP协议有三个组成部分：

<img src="./计算机网络/3.7.2-1.png" alt="3.7.2-1png" style="zoom:80%;" />

- **PPP帧**

<img src="./计算机网络/3.7.2-2.png" alt="3.7.2-2" style="zoom:80%;" />

**1）标志字段(F)**：前后各占一个字节，**若它出现在信息字段中，就必须做字节填充**，使用的控制转义字节是**7D(01111101)**。

**2）地址字段(A)**：占1字节。

**3）控制字段(C)**：占1字节。

**4）协议段**：占2字节，在HDLC中没有改字段，它是**说明信息段中运载的是什么种类的分组**。以比特0开始的是诸如IP、IPX和AppleTalk这样的网络层协议；以比特1开始的被用来协商其他协议，包括LCP及每个支持的网络层协议的一个不同的NCP。

**5）信息段**：是可变的，0~1500B。

**【注】**因为**PPP是点对点的，不是总线形，所以无须采用CSMA/CD协议，自然就没有最短帧**，所以信息段占0~1500字节，而不是46~1500字节。另外，当数据部分出现和标准位一样的比特组合时，就需要一些措施来实现透明传输。

**6）帧检验序列(FCS)**：占2字节，即**循环冗余码检验中的冗余码**。检验区包括**地址字段、控制字段、协议字段和信息字段**。

**【注】**

<img src="./计算机网络/3.7.2-3.png" alt="3.7.2-1png" style="zoom:80%;" />

<img src="./计算机网络/3.7.2-4.png" alt="3.7.2-4" style="zoom:80%;" />



#### 3.7.3 HDLC协议

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2013-37</font>

&emsp;&emsp;**高级数据链路控制(High-level Data Link Control，HDLC)协议**是**ISO制定**的**面向比特**的数据链路层协议。

**【注】**PPP协议是面向字节的

- **特点**

1）**不依赖于任何一种字符编码集**

2）**数据报文可透明传输**，用于实现透明传输的**"0"比特插入法(比特填充法)**易于硬件实现

3）**全双工通信**，有较高的数据链路传输效率

4）**所有帧采用CRC校验**，对信息帧进行**顺序编码**，可防止漏收或重发，传输可靠性高

5）**传输控制功能与处理功能分离**，有较大的灵活性



- HDLC适用于链路的两种基本配置：**非平衡配置**和**平衡配置**

1）非平衡配置的特点是由**一个主站控制整个链路的工作**

2）平衡配置的特点是链**路两端的两个站都是复合站**，每个复合站都可以平等地发起数据传输，而不需要得到对方复合站的允许



1. **站**

&emsp;&emsp;HDLC有3种站类型：**主站**、**从站**和**复合站**。

- **主站负责控制链路的操作**，主站发出的帧称为**命令帧**。
- **主站受控于从站**，按主站的命令进行操作，发出的帧称为**响应帧**。
- 有些站既具有主站的功能，又具有从站的功能，所以这类站称为复合站，它可以发出命令帧和响应帧。

2. **数据操作方式**

<img src="./计算机网络/3.7.3-1.png" alt="3.7.3-1" style="zoom:80%;" />

3. **HDLC帧**

<img src="./计算机网络/3.7.3-2.png" alt="3.7.3-2" style="zoom:80%;" />

- **标志字段F：01111110**

&emsp;&emsp;在接收端只要找到标志字段就可以确定一个帧的位置。HDLC协议采用**比特填充的首位标志法**实现透明传输。

- **地址字段A**

&emsp;&emsp;共8位，在使用**非平衡方式**传送数据时，站地址字段总是先写入**从站的地址**，在使用**平衡方式**传送数据时，站地址字段填入的是**应答站的地址**。

- **控制字段C**

&emsp;&emsp;共8位，是最复杂的字段。HDLC的许多重要功能都靠控制字段来实现。根据其第1位或第1、2位的取值，可将HDLC帧划分为三类：

<img src="./计算机网络/3.7.3-3.png" alt="3.7.3-3" style="zoom:80%;" />

- **PPP帧和HDLC帧的区别**

<img src="./计算机网络/3.7.3-4.png" alt="3.7.3-4" style="zoom:80%;" />



### 3.8 数据链路层设备

#### 3.8.1 网桥的概念及其基本原理

&emsp;&emsp;两个或多个以太网通过网桥连接后，就称为一个覆盖范围更大的以太网，从而**原来的每个以太网就称为一个网段**。**网桥工作在链路层的MAC子层**，可以使以太网各段成为**隔离开的碰撞域**。

> 如图例：设每个网段的速率都是10Mb/s，那么三个网段合起来最大吞吐率就变成了30Mb/s。如果把两个网桥换成集线器或转发器，那么整个网络仍然是一个碰撞域(即冲突域)，当A与B通信时，所有其它结点都不能通信，整个碰撞域的最大吞吐量仍然是10Mb/s。

<img src="./计算机网络/3.8.1-1.png" alt="3.8.1-1" style="zoom:80%;" />

- **网桥的基本特点**

① 具备寻址和路径选择能力，以确定帧的传输方向

② 从源网络接收帧，以目的网络的介质访问控制向目的网络转发该帧

③ 网桥在不同或相同类型的LAN之间存储并转发帧，必要时还进行链路上的协议转换

**【注】**一般情况下，存储转发类设备都能进行协议转换，即连接的两个网段可以使用不同的协议

④ 网桥**对接收到的帧不做任何修改**，或只对帧的封装格式做很少的修改

⑤ 网桥可以通过执行帧翻译互联不同类型的局域网，即把原协议的信息段内容作为另一个协议的信息封装在帧中

⑥ 网桥应该有足够大的缓冲空间，因为在短时间内帧到达速率可能高于转发速率。

- **网桥的优点**

① 能过滤通信量  ② 扩大物理范围  ③ 可使用不同的物理层

④ 可互联不同类型的局域网  ⑤ 提高了可靠性  ⑥性能得到改善

- **网桥的缺点**

① 增大了时延  ② MAC子层**没有流量控制功能**  

③ 不同MAC子层的网段连接在一起时，需要进行帧格式的转换

④ 网桥**只适合于用户不多和通信量不大的局域网**，否则还会因传播过多的广播信息而产生网络拥塞，这就是**广播风暴**

**【注】**：网桥只隔离冲突域，不隔离广播域。



1. **透明网桥(选择的不是最佳路由)**

&emsp;&emsp;透明网桥以混杂方式工作，它**接收与之连接的所有LAN传送的每一帧**。到达帧的路由选择过程取决于源LAN和目的LAN：

① 如果源LAN和目的LAN相同，那么丢弃该帧

② 如果源LAN和目的LAN不同，那么转发该帧

③ 如果目的LAN未知，那么扩散该帧

&emsp;&emsp;当网桥刚连接到以太网时，其转发表如果是空的，网桥按照自学习算法处理收到的帧。

**【注】**处理帧的算法有**① 延相反路径查找** **② 生成树算法**

2. **源路由网桥(选择的是最佳路由)**

&emsp;&emsp;在源路由网桥中，**路由选择由发送数据帧的源站负责**，网桥只根据数据真正的路由信息对帧进行接收和转发。

**【注】**处理帧的算法是以**广播的方式**发送一个**发现帧**作为探测作用，然后源站选择一条最佳路由。

3. **两种网桥的比较**

① 使用源路由网桥可以利用最佳路由。若在两个以太网之间使用并联的源路由网桥，则还可以使通信量比较平均地分配给每个网桥。

② 采用透明网桥时，只能使用生成树，而使用生成树一般并不能保证所用的路由是最佳的。



#### 3.8.2 局域网交换机(Switch)及其工作原理

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2009-36,2014-34,2015-37,2016-33/35</font>

1. **局域网交换机**

&emsp;&emsp;**桥接器的主要限制是在任一时刻通常只能执行一个帧的转发操作**，于是出现了局域网交换机，又称为以太网交换机。从**本质上看，以太网交换机是一个多端口的网桥**，它工作在数据链路层，交换机能经济地将网络分成小的冲突域，为每个工作站提供更高的带宽。

**【注】**利用以太网交换机可以实现**虚拟局域网(VLAN)**，VLAN**不仅可以隔离冲突域，而且可以隔离广播域**。

2. **原理**

&emsp;&emsp;它检测从以太网端口来的数据帧的**源和目的地的MAC(介质访问层)地址**，然后与系统内部的动态查找表进行比较，若数据帧的MAC地址不在查找表中，则将该地址加入查找表，并将数据帧发送给相应的目的端口。

**【注】**若查找表中没有目的地址，则采取广播的形式将数据帧传送给目的端口，同时目的主机收到数据帧后将发送一个确认帧给源主机，同时在查找表中记录该信息。

3. **特点**

1）以太网交换机的每个端口与单主机相连(普通网桥的端口往往连接到以太网的一个网段)，并且一般都工作在**全双工方式**。

2）以太网交换机能同时连通多对端口时，使每对相互通信的主机都能像独占媒体那样，无碰撞地传输数据。

3）以太网交换机也是一种即**插即用设备(和透明网桥一样)**，其内部的帧的转发表也是通过**自学习**自动逐渐建立起来的。

4）以太网交换机由于使用了专用的交换结构芯片，因此交换速率较高。

5）以太网独占传输媒体的带宽。

> 例：对于普通10Mb/s的**共享式以太网**，若共有N个用户，则每个用户占有的平均带宽只有总带宽的1/N。在使用以太网交换机时，虽然从每个端口到主机的带宽还是10Mb/s，但由于一个用户在通信时是独占而不是和其他网络用户共享传输媒体的带宽，因此拥有N对端口的交换机总容量是N&times;10Mb/s。

4. **两种交换模式**

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2013-38</font>

**1）直通式**：直通式交换机**只检查帧的目的地址(6B)**，这使得帧在接收后几乎马上被传出去。

**优点**：传输速率块

**缺点**：缺乏智能性和安全性，也无法支持具有不同速率的端口的交换

**2）存储转发式**：存储转发交换机将接收到的帧缓存到高速缓冲区，并检查数据是否正确，确认无误后通过查找表转换成输出端口将该帧发送出去，如果发现帧有错就将其丢弃。

**优点**：可靠性高，能支持不同速率端口的转换

**缺点**：延迟较大

**【注】**路由器的传输延迟最大。



## 第4章 网络层

### 4.1 网络层的功能

#### 4.1.1 异构网络互联

&emsp;&emsp;所谓的网络互联，是将两个以上的计算机网络，通过一定的方法，用一种或多种通信设备(即中间设备)相互连接起来，以构成更大的网络系统。中间设备又称为中间系统或中继系统。根据所在的层次，分为以下4种：

**1）物理层中继系统**：中继器，集线器(Hub)

**2）数据链路层中继系统**：网桥或交换机

**3）网络层中继系统**：路由器

**4）网络层以上的中继系统**：网关

**【注1】**路由器连接的异构网络是指数据链路层和物理层均不同

**【注2】**在路由器互联的多个局域网的结构中，要求每个局域网物理层、数据链路层、网络层协议可以不同，而网络层以上的高层协议必须相同。

#### 4.1.2 路由与转发

- **路由选择(确定那一条路径)**

&emsp;&emsp;根据特定的路由选择协议构造出路由表，同时经常或定期和相邻路由器交换路由信息而不断更新和维护路由表。

- **分组转发(当一个分组到达时所采取的动作)**

&emsp;&emsp;路由器根据转发表将用户的IP数据报从合适的端口转发出去。

#### 4.1.3 拥塞控制

- **拥塞控制**

&emsp;&emsp;在通信子网中，因出现过量分组而引起的网络性能下降的现象称为拥塞。判断网络是否进入拥塞状态的方法是，观察网络的吞吐量与网络负载的关系。

- **拥塞控制与流量控制的区别**

<img src="./计算机网络/4.1.3-1.png" alt="4.1.3-1" style="zoom:80%;" />

- **拥塞控制的两种方法**

<img src="./计算机网络/4.1.3-2.png" alt="4.1.3-2" style="zoom:80%;" />



### 4.2 路由算法

#### 4.2.1 静态路由和动态路由

1. **静态路由算法(非自适应路由算法)**：指由网络管理员手工配置的路由信息。

2. **动态路由算法(自适应路由算法)**：指路由器上的路由表是通过相互连接的路由器之间彼此交换信息，然后按一定的算法优化出来的，而这些路由信息会在一定时间间隙里不断更新，以适应不断变化的网络，以随时获得最优的寻路效果。

#### 4.2.2 距离-向量路由算法

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2010-35,2016-37</font>

&emsp;&emsp;在距离-向量路由算法中，所有结点都定期地将它们的整个路由选择表传送给所有**与之直接相邻的**结点。这种路由选择表包含：

- **每条路径的目的地(另一结点)**
- **路径的代价(也称为距离)**

**【注1】**常见的距离-向量路由算法是**RIP算法**，RIP将距离定义为“跳数”，跳数指从源端口到达目的窗口所经过的路由个数，每经过一个路由器，跳数加1。**跳数>=16表示不可到达**。

**【注2】**RIP的特点是“坏消息传得慢”。

#### 4.2.3 链路状态路由算法

&emsp;&emsp;链路状态路由算法要求每个参与该算法的结点都具有完全的网络拓扑结构，它执行下述两项任务：

1）主动测试所有邻接结点的状态。

2）定期地将链路状态传播给所有其它结点(或称路由结点)。

典型的链路状态算法是**OSPF算法**。一旦链路状态发生变化，结点就对更新的网络图利用**Dijsktra**最短路径算法重新计算路由，从单一的源出发到达所有目的结点的最短路径。

- **链路状态路由算法的三个特征**

<img src="./计算机网络/4.2.3-1.png" alt="4.2.3-1" style="zoom:80%;" />

**【注】**链路状态路由算法适合**大型或路由信息变化聚敛**的互联网环境。

- **优点**

<img src="./计算机网络/4.2.3-2.png" alt="4.2.3-2" style="zoom:80%;" />

- **距离-向量路由算法 VS 链路状态路由算法**

<img src="./计算机网络/4.2.3-3.png" alt="4.2.3-3" style="zoom:80%;" />

**【注】**”慢收敛“是距离-向量算法导致路由环路的原因，而“好消息传得快，坏消息传得慢”使得路由信息发生变化时，该变化未能及时被所有路由知道，而仍然可能在路由器之间进行传递，导致了“慢收敛”。

#### 4.2.4 层次路由

&emsp;&emsp;当网络规模扩大时，路由器的路由表成比例增大。这不仅会消耗越来越多的路由器缓冲区空间，而且需要更多的CPU时间来扫描路由表，用更多的带宽来交换路由状态信息。因此路由选择必须按照层次方式进行。

&emsp;&emsp;因特网将**整个系统划分为许多较小的自治系统(注意一个自治系统包含很多局域网)**。每个自治系统有权自主地决定本系统内采用何种路由协议。如果两个自治系统就需要通信，那么就需要一种在两个自治系统之间的协议来屏蔽这些差异。因此，因特网把路由协议划分为两大类：

<img src="./计算机网络/4.2.4-1.png" alt="4.2.4-1" style="zoom:80%;" />





### 4.3 IPv4

<font color='#0099ff' size=5 face="黑体">大题：</font><font color='#FF0000' size=4 face="黑体">2009-47,2011-47,2012-47,2013-47,2014-47,2015-47</font>

#### 4.3.1 IPV4分组

1. **IPV4分组的格式**

&emsp;&emsp;一个IP分组由首部和数据两部分组成。**首部前一部分长度固定，共20B**，是所有IP分组必须具有的。首部固定部分的后面是一些可选字段，其长度可变，用来提供错误检查及安全等机制。IP数据报格式如图：

![4.3.1-1](./计算机网络/4.3.1-1.png)

- **IP首部的部分重要字段**

（1）**版本**：指IP的版本，目前广泛使用的版本为**4**。

（2）**首部长度**：占4位，以**32位(4B)**为单位，最大值为**60B(15$\times$4B)**。最常用的首部长度是20B，此时不含有任何选项(即可选字段)。

（3）**总长度**：占16位。指首部和数据之和的长度，单位为字节，因此数据报的最大长度为$2^{16}-1=65535$B。**以太网的最大传输单元(MTU)为1500B**，因此一个IP数据报封装成帧时，数据报的总长度(首部加数据)一定不能超过先数据链路层的MTU值。

**【注】**快速以太网数据帧有效载荷的最小长度为 **46** 字节，即长度不够需要填充。

（4）**标识**：占16位。它是一个**计数器**，每产生一个数据报就加1，并赋值给标识字段。当一个数据报的长度超过网络的MTU时，必须分片，此时每个数据报片都复制一次标识号，以便能正确重载成原来的数据报。

**【注】**用来追踪IP分组的去向

（5）**标志**：占3位。最低位为MF，**MF=1表示后面还有分片，MF=0表示最后一个分片**。标志字段中间一位是DF，只有**DF=0才允许分片**。

（6）**片偏移**：占13位。它指出较长的分组在分片后，谋片在原分组中的相对位置。**片偏移以8个字节为偏移单位**，即**每个分片的长度一定是8B(64位)的整数倍**。

（7）**首部校验和**：占16位。IP数据报的首部校验和**只校验分组的首部**，不校验数据部分。

 （8）**生存时间(TTL)**：占8位。**数据报在网络中可通过的路由器的最大值**，标识分组在网络中的寿命，以确保分组不会永远在网络中循环。路由器在转发分组前，先把TTL减1。若TTL被减为0，则该分组必须丢弃。

（9）**协议**：占8位。指出此分组携带的数据使用何种协议，即分组的数据应交给哪个传输层协议。其中值为**6标识TCP**，值为**17表示UDP**。

（10）**源地址字段**：占4B，标识发送方的IP地址。

（11）**目的地址字段**：占4B，标识接收方的IP地址。

**【注1】**：**首部长度、总长度和片偏移的单位分别为4B、1B、8B**。

**【注2】**：IP分组每经过一个路由器转发，需要改变IP分组头的字段有：**IP源地址、TTL-1、校验和**

2. **IP数据报分片**

&emsp;&emsp;一个长**4000B的IP数据报(首部20B，数据部分3980B)**到达一个路由器，需要转发到一条MTU为1500B的链路上。分片情况如下

<img src="./计算机网络/4.3.1-2.png" alt="4.3.1-2" style="zoom:80%;" />

**【注】**分片是在路由器中进行的，最后是在目的主机中重组。

3. **网络层转发分组的流程**

（1）从数据报的首部提取目的主机的IP地址D，得出目的网络地址N。

（2）若网络N与此路由器直接相连，则把数据报直接交付给目的主机D，这称为路由器的**直接交付**。否则是间接交付，执行步骤3。

（3）若路由表中有目的地址为D的特定主机路由，把数据报传送给路由表中所指定的下一跳路由；否则，执行步骤4。

（4）若路由表中有到达网络N的路由，则把数报据传送给路由表指明的下一跳路由器，否则，执行步骤5。

（5）若路由表中有一个默认路由，则把数据报传送给路由表所指定的默认路由表，否则，执行步骤6。

（6）报告分组出错。

**【注】**：得到下一跳路由器的IP地址后不是直接将该地址填入待发送的数据报，而是将该IP地址转换成MAC地址(通过**ARP**)，将其放到MAC帧首部中，然后根据这个MAC地址找到下一跳路由器。

**在不同网络中传递时，MAC帧中的源地址和目的地址要发生变化，但是网桥在转发帧时，不改变帧的源地址。**

#### 4.3.2 IPV4地址与NAT

1. **IPV4地址**

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2017-36</font>

**IP地址={<网络号>,<主机号>}**，一个IP地址在整个因特网范围是唯一的。

![4.3.2-1](./计算机网络/4.3.2-1.png)

在各类IP地址中，有一些IP地址具有特殊用途，不用做主机的IP地址：

- **主机号全0**：表数网络本身，如202.98.174.0
- **主机号全1**：表示本网络的广播地址，又称**直接广播地址**，如202.98.174.255
- **127.0.0.0**：环路自检地址，此地址表示任意主机本身
- **127.0.0.1**：回送地址，以它为目的IP地址的数据将被立即返回本机
- **32位全为0**：即0.0.0.0表示本网络上的本主机
- **32位全为1**：即255.255.255.255表示整个TCP/IP网络的广播地址，又称为**受限广播地址**。实际使用时，由于路由器对广播域的隔离，255.255.255.255等效为本网络的广播地址。

<img src="./计算机网络/4.3.2-2.png" alt="4.3.2-2" style="zoom:90%;" />

- **IP地址的重要特点**

（1）用转发器或桥接器(网桥等)连接的若干LAN仍然是同一个网络(同一个广播域)，因此该LAN中所有主机的IP地址的网络号必须相同，但主机号必须不同。

（2）在同一局域网上的主机或路由器的IP地址中的网络号必须是一样的。**路由器总是具有两个或两个以上的IP地址**，路由器的**每个端口都有一个不同网络号的IP地址**。

**【注1】**一个主机可以拥有多个IP地址，但IP地址的网络号必须不同。

**【注2】**路由器在通信过程中，首部的源IP地址和目的IP地址在经过路由器时不会发生改变。



2. **网络地址转换(NAT)**

&emsp;&emsp;网络地址转换是指通过将专用的网络地址转换为公用地址，从而对外隐藏内部管理的IP地址。它使得整个专用网络**只需要一个全球IP地址**就可以与因特网连通，由于**专用网本地IP地址是可重用的**，所以NAT大大节省了IP地址的消耗。

&emsp;&emsp;私有IP地址只用于LAN，不用于WAN连接，私有的IP地址网段如下：

<img src="./计算机网络/4.3.2-3.png" alt="4.3.2-3" style="zoom:80%;" />

&emsp;&emsp;NAT路由器使用NAT转换表将本地地址转换成全球地址，或将全球地址转换成本地地址。NAT转换表中存放着**{本地IP地址:端口}**到**{全球IP地址:端口}**的映射，通过这种方式，可将多个私有IP地址映射到同一个全球IP地址。

- **例子**

<img src="./计算机网络/4.3.2-4.png" alt="4.3.2-4" style="zoom:80%;" />

**【注1】**NAT工作在**传输层**。

**【注2】**NAT表项需要管理员添加，当找不到对应的项时，服务器会直接丢弃该IP分组。



#### 4.3.3 子网划分与子网掩码、CIDR

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2010-37,2011-37/38,2012-39,2016-39,2017-28</font>

1. **子网划分**

$$
IP地址 = 	\{<网络号>,<子网号>,<主机号>\}
$$

- 子网划分纯属于一个单位内部的事情，单位对外仍然表现为没有划分子网的网络。

**【注1】**

1）划分子网**只是把IP地址的主机号部分进行划分**，而不改变IP地址原来的网络号。因此从一个IP地址本身或IP数据报的首部，无法判断源主机或目的主机所连接的网络是否进行了子网划分。

2）CIDR的子网号可以全0或1，但主机号不能全0或1。主机号全0表示子网的网络号，主机号全1的地址为子网的广播地址。

**【注2】**之所以划分子网，这样做的好处是可以减少广播域的大小。



2. **子网掩码**

&emsp;&emsp;为了告诉主机或路由器对一个A类、B类、C类网络进行了子网划分，使用子网掩码来表达对原网络中主机号的错位。

&emsp;&emsp;**子网掩码**是一个与IP地址相对应的、长32bit的二进制串，它由一串1和跟随的一串0组成，其中，1对应于IP中的<font color='#0099ff'>网络号</font>和<font color='#0099ff'>子网号</font>，而0对应于主机号。计算机只需将IP地址和对应的子网掩码逐位“与”(逻辑AND运算)，即可得出相应子网的网络地址。

> 某主机的IP地址：192.168.5.56，子网掩码：255.255.255.0，进行逐位“与”运算后，得出该主机所在子网的网络号为：192.168.5.0

- **使用子网掩码的情况下：**

1）一台主机在设置IP地址信息的同时，必须设置子网掩码。

2）同属于一个子网的所有主机及路由器的相应接口，必须设置相同的子网掩码。

3）路由器的路由表中，所包含的信息主要内容必须有**网络地址**、**子网掩码**、**下一跳地址**。

**【注】**位于不同子网中的主机之间相互通信时，路由器在转发IP数据时，需要**重新封装源硬件地址和目的硬件地址**。



3. **无分类域间路由选择(CIDR)**

CIDR的主要特点如下：

1）消除了传统的A、B、C类地址及划分子网的概念，因而可以更有效地分配IPV4的地址空间。CIDR使用“网络前缀”的概念代替子网络的概念。因此，IP地址的无分类两级编址为
$$
IP地址 = 	\{<网络前缀>,<主机号>\}
$$
CIDR还使用“斜线记法”，即**IP地址/网络前缀所占比特数**。其中，网络前缀所占比特数对应网络号的部分，等效于子网掩码中连续1的部分。

> 例如，对于128.14.32.5/20，它的掩码是20个连续的1和后续12个连续的0，通过逐位相“与”的方法可以得到该地址的网络前缀(或直接取前20位)：

<img src="./计算机网络/4.3.3-1.png" alt="4.3.3-1" style="zoom:80%;" />

CIDR虽然不适用子网，但仍然使用“掩码”一词。“CIDR不使用子网“是指CIDR并没有在32位地址中指明若干位作为子网字段。但分配到一个CIDR地址块的组织，仍可以在本组织划分出一些子网号。

> 例如，某组织分配到地址块/20，就可以再继续划分成8个子网(从主机中借用3位来划分子网)，这时每个子网的网络前缀就变成了23位。全0和全1的主机号地址一般不使用。

2）将**网络前缀都相同的连续IP地址组成“CIDR地址块”**，一个CIDR地址快可以表示很多地址，这种地址的聚合称为**路由聚合**，或称为**超网**。

3）**最长前缀匹配(最佳匹配)**：使用CIDR时，路由表中的每个项目由“网络前缀”和“下一跳地址”组成。在查找路由表时可能得到不止一个匹配结果。此时，应从匹配结果中**选择具有最长网络前缀的路由**。



#### 4.3.4 ARP、DHCP和ICMP

1. **IP地址与硬件地址**

**【注】**路由器由于互联多个网络，因此它不仅有多个IP地址，也有多个硬件地址。



##### 2. 地址解析协议(ARP)

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2012-38</font>

<font color='#0099ff' size=5 face="黑体">大题：</font><font color='#FF0000' size=4 face="黑体">2011-47</font>

&emsp;&emsp;无论网络层使用什么协议，在实际网络的链路上传送数据帧时，最终必须使用硬件地址，所以需要一种方法来**完成IP地址到MAC地址的映射**。

- **IRP工作原理**

<img src="./计算机网络/4.3.4-1.png" alt="4.3.4-1" style="zoom:80%;" />

**【注】**ARP是网络层协议。

- **ARP的4种典型情况**

<img src="./计算机网络/4.3.4-2.png" alt="4.3.4-2" style="zoom:80%;" />

##### 3. 动态主机配置协议(DHCP)

<font color='#0099ff' size=5 face="黑体">大题：</font><font color='#FF0000' size=4 face="黑体">2011-47</font>

&emsp;&emsp;动态主机配置协议(Dynamic Host Configuration Protocol, DHCP)常**用于给主机动态地分配IP地址**，它提供了即插即用联网机制，这种机制允许一台计算机加入新的网络和获取IP地址而不用手工参与。**DHCP是应用层协议，它是基于UDP的**。

- **工作原理**

&emsp;&emsp;使用**客户/服务器**方式。需要IP地址的主机**在启动时就向DHCP服务器广播发送发现报文**，这时该主机就成为DHCP客户**(源IP地址：0.0.0.0 目的IP地址：255.255.255.255)**。

&emsp;&emsp;本地网络上所有主机都能收到此广播报文，但**只有DHCP服务器才回答次广播报文**。DHCP服务器先在其数据库中查找该计算机的配置信息。若找到，则返回找到信息。若找不到，则从服务器的IP地址池置中取出一个地址分配给该计算机。**DHCP服务器的回答报文提供报文**。

- **DHCP服务器聚合DHCP客户端的交换过程如下：**

<img src="./计算机网络/4.3.4-3.png" alt="4.3.4-3" style="zoom:80%;" />

**【注1】DHCP允许网络上分配多台DCHP服务器**，当DHCP客户机发出DHCP请求时，有可能收到多个应答信息。这时，DHCP客户机只会挑选其中一个，**通常是最先到达的**。

**【注2】DHCP分配给DHCP客户机的IP地址是临时的**，因此DHCP客户只能在一段有限的时间内使用这个分配到的IP地址。DHCP称这段时间为**租用期**。租用期的数值应该由DHCP服务器自己决定，DHCP客户也可以在自己发送的报文中提出对租用期的要求。



##### 4. 网际控制报文协议(ICMP)

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2010-36,2012-33</font>

&emsp;&emsp;为提高IP数据报交付的成功机会，在网络层使用了**网际控制报文协议(Internet Control Message Protocol，ICMP)**来让主机或路由器报告差错报文和异常情况。

&emsp;&emsp;**ICMP报文作为IP层数据报的数据**，加上数据报的首部，组成IP数据报发送出去。**ICMP是IP层协议**，分为ICMP差错报文和ICMP询问报文。

- **ICMP差错报文**

ICMP差错报文用于目标主机或到目标主机路径上的路由器向源主机报告差错和异常情况。

​	**1）终点不可达**。当路由器或主机不能交付数据报时，就向源点发送终点不可达报文。

​	**2）源点抑制**。当**路由器或主机由于拥塞而丢弃数据报**时，就向源点发送源点抑制报文，使源点知道应当把数据报的发送速率放慢。

​	**3）时间超时**。当路由器收到**生成时间(TTL)为零**的数据报时，**除丢弃该数据报外，还要向源点发送超过报文**。当终点在预先规定时间内不能收到一个数据的全部数据报片时，就把已收到的数据报片都丢弃，并向源点发送时间超过报文。

​	**4）参数问题**。当路由器或目的主机收到的数据报的首部中有的字段值不正确时，就丢弃该数据，并向源点发送参数问题报文。

​	**5）改变路由(重定向)**。路由器把改变路由报文发送给主机，让主机知道下次应将数据报发送给另外的路由器(可通过更好的路由)。



**不应发送ICMP差错报告报文的几种情况如下：**

​	1）对ICMP差错报文不再发送ICMP差错报告报文。

​	2）对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文。

​	3）对具有**组播地址**的数据报都不发送ICMP差错报告报文。

​	4）对具有**特殊地址(如127.0.0.0或0.0.0.0)**的数据报不发送ICMP差错报告报文。



- **ICMP询问报文**

  **1）回送请求和回答报文**

  **2）时间戳请求和回答报文**

  3）掩码地址请求和回答报文

  4）路由器询问和通告报文

**其中最常用的是1）2）**

**【注1】**ICMP的两个常见应用是**分组间探测PING(**用来测试两台主机之间的连通性)和**Traceroute**(Unix中的名字，在windows中是tracert，可以用来跟踪分组经过的路由)。其中PING使用了**ICMP回送请求和回答报文**。Traceroute(tracert)使用了**ICMP时间超过报文**。

**【注2】PING工作在应用层**，它直接使用网络层的ICMP，而未使用传输层的TCP或UDP，Traceroute/Tracert工作在网络层。



### 4.4 IPv6

#### 4.4.1 IPv6的主要特点

- **解决IP耗尽问题的措施**

① 采用无类别编制CIDR，使IP地址分配更加合理

② 采用网络地址转换(NAT)方法以节省全球IP地址

③ 采用具有更大地址空间的新版本IPv6

- **IPv6的主要特点**

<img src="./计算机网络/4.4.1-1.png" alt="4.4.1-1" style="zoom:80%;" />

#### 4.4.2 IPv6地址

&emsp;&emsp;IPv6数据报的目的地址可以是以下三种基本类型之一：

**1）单播**：传统的点对点通信。

**2）多播**：多播是一点对多点的通信，分组被交付到一组计算机的每台计算机。

**3）任播**：这是IPv6新增的一种类型。任播的目的站是一组计算机，但数据报在**交付时只能交付其中的一台计算机**，通常是**距离最近的一台计算机**。

- **IPv6地址表示**

&emsp;&emsp;IPv6把地址中**每4位用一个十六进制表示，并用冒号分隔每16位**，如

4BF5:AA12:0216:FEBC:BA5F:039A:BE9A:2170。

&emsp;&emsp;通常可以把IPv6地址缩写成更紧凑的形式。当16位域的开头有一些0时，可以采用一种缩写表示法，但**在域中必须至少一个数字**。例如，可以把4BF5:0000:0000:0000:BA5F:039A:000A:2176缩写为4BF5:0:0:0:BA5F:39A:A:2176。

&emsp;&emsp;当有相继的0值域时，还可以进一步缩写。这些域可以用双冒号缩写(::)。**双冒号法表示法在一个地址中仅能出现一次**。上述的表示缩写为4BF5::BA5F:39A:A:2176

- **IPv6的分级结构**

**1）第一级(顶级)**：指明全球都知道的公共拓扑

**2）第二级(场点级)**：指明单个场点

**3）第三级**：指明单个网络接口

- **IPv4向IPv6过渡的方案**

**1）双协议栈**：一部分主机(或路由器)装有两个协议栈

**2）隧道技术**：将整个IPv6数据报封装到IPv4数据报的数据部分，使得IPv6可以在IPv4网络的隧道中传输。



### 4.5 路由协议

#### 4.5.1 自治系统

&emsp;&emsp;自治系统(Autonomous System, AS)：**单一技术管理下的一组路由器**，这些路由器使用一种**AS内部的路由选择协议**和共同的度量来确定分组在该AS内的路由，同时还使用一种AS之间的路由协议来确定分组在AS之间的路由。

&emsp;&emsp;一个自治系统内的所有网络都由一个行政单位(如一家公司、一所大学、一个政府部门等)管辖，**一个自治系统的所有路由器在本系统内部必须都是连通的**。

#### 4.5.2 域内路由与域间路由

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2017-37</font>

<font color='#0099ff' size=5 face="黑体">大题：</font><font color='#FF0000' size=4 face="黑体">2013-47</font>

- **域内路由**：自治系统内部的路由选择
- **域间路由**：自治系统之间的路由选择

1. **内部网关协议(Interior Gateway Protocol, IGP)**

&emsp;&emsp;内部网关协议即在一个自治系统内部使用的路由协议，它**与互联网中其它自治系统选用什么路由协议无关**。目前这类路由选择协议使用得最多，如**RIP**和**OSPF**。

**【注】**RIP协议的报文会被封装在UDP中，OSPF协议的报文会被封装在IP中。

2. **外部网关协议(External Gateway Protocol, EGP)**

&emsp;&emsp;若源站和目的站处于不同的自治系统中，当数据报传到一个自治系统的边界时(两个自治系统可能使用不同的IGP)，就需要一种协议将路由选择信息传递到另一个自治系统中。这样的协议就是外部网关协议(EGP)。目前使用最多的的外部网关无关协议是**BGP-4**。

<img src="./计算机网络/4.5.2-1.png" alt="4.5.2-1" style="zoom:80%;" />

**【注】**BGP-4协议的报文会被封装在**TCP协议段**中进行传输。



#### 4.5.3 路由信息协议(RIP)

&emsp;&emsp;路由信息协议(Routing Information Protocol, RIP)是内部网关协议(IGP)中最先得到广泛应用的协议。RIP是一种**分布式**的基于**距离向量**的路由选择协议，其最大的优点是**简单**。

- **RIP规定**

<img src="./计算机网络/4.5.3-1.png" alt="4.5.3-1" style="zoom:80%;" />

- **RIP的特点**

1）仅和相邻的路由器交换信息。

2）路由器交换的信息是当前路由器知道的全部信息，即自己的路由表。

3）按固定的时间间隔交换路由信息，如每隔30秒。

- **距离向量算法**

&emsp;&emsp;每个路由表项目中都有三个关键字数据：<目的网络N，距离d，下一跳路由器X>。对于每个相邻路由器发送过来的RIP报文，执行如下步骤：

<img src="./计算机网络/4.5.3-2.png" alt="4.5.3-2" style="zoom:80%;" />

- **RIP的缺点**

RIP的最大优点是实现简单、开销小、收敛过程较快(小型网络而言)。

<img src="./计算机网络/4.5.3-3.png" alt="4.5.3-3" style="zoom:80%;" />

**【注】**RIP是**应用层协议**，它使用**UDP传送数据(端口520)**。RIP选择的**路径不一定是时间最短的，但一定是具有最少路由器的路径**。



#### 4.5.4 开放最短路径优先(OSPF)协议

&emsp;&emsp;开放最短路径优先(OSPF)协议是使用**分布式链路状态路由算法**的典型代表，也是**内部网关协议(IGP)的一种**。

- **OSPF与RIP的区别**

<img src="./计算机网络/4.5.4-1.png" alt="4.5.4-1" style="zoom:80%;" />

<img src="./计算机网络/4.5.4-2.png" alt="4.5.4-2" style="zoom:80%;" />

- **OSPF特点**

<img src="./计算机网络/4.5.4-3.png" alt="4.5.4-3" style="zoom:80%;" />

- **OSPF的基本工作原理**

<img src="./计算机网络/4.5.4-4.png" alt="4.5.4-4" style="zoom:80%;" />

**【注】**虽然使用Dijkstra算法能计算出完整的最优路径，但路由表中不会存储完整路径，而是只存储“下一跳”。

- **OSPF的五种分组类型**

<img src="./计算机网络/4.5.4-5.png" alt="4.5.4-4" style="zoom:80%;" />

<img src="./计算机网络/4.5.4-6.png" alt="4.5.4-6" style="zoom:80%;" />

**【注】**OSPF协议使用**Hello分组**来保持与其邻居的连接。

#### 4.5.5 边界网关协议(BGP)

&emsp;&emsp;边界网关协议(Border Gateway Protocol, BGP)是不同自治系统的路由器之间交换路由信息的协议，是一种**外部网关协议**。边界网关协议常用于互联网的网关之间。

&emsp;&emsp;BGP只能力寻找一条能够到达目的网络**比较好的路由，而并非一条最佳路由**。BGP采用的是**路径-向量**路由选择协议，它与距离向量和链路状态协议有很大的区别。BGP是**应用层协议**，它是基于**TCP**的。

- **BGP的工作原理**

<img src="./计算机网络/4.5.5-1.png" alt="4.5.5-1" style="zoom:80%;" />

<img src="./计算机网络/4.5.5-2.png" alt="4.5.5-2" style="zoom:80%;" />

<img src="./计算机网络/4.5.5-3.png" alt="4.5.5-3" style="zoom:80%;" />

- **BGP的特点**

<img src="./计算机网络/4.5.5-4.png" alt="4.5.5-4" style="zoom:80%;" />

<img src="./计算机网络/4.5.5-5.png" alt="4.5.5-5" style="zoom:81%;" />

<img src="./计算机网络/4.5.5-6.png" alt="4.5.5-6" style="zoom:80%;" />

- **BGP-4共使用4种报文**

<img src="./计算机网络/4.5.5-7.png" alt="4.5.5-7" style="zoom:80%;" />

- **RIP、OSPF与BGP的比较**

<img src="./计算机网络/4.5.5-8.png" alt="4.5.5-8" style="zoom:80%;" />



### 4.6 IP组播

#### 4.6.1 组播的概念

&emsp;&emsp;为了能够支持像**视频点播**和**视频会议**这样的多媒体应用，网络必须实施某种有效的组播机制。**组播一定仅应用于UDP(TCP需要建立连接)**，它对将报文同时发送往多个接收者的应用来说非常重要。 **主机可以选择加入或离开一个组，因此一台主机可以同时属于多个分组**。

&emsp;&emsp;在IPv4中，这些地址在**D类地址**空间中分配，而IPv6也有一部分地址空间保留给组播。

&emsp;&emsp;主机使用一个称为**IGMP(因特网组管理协议)**的协议加入组播组。它们使用该协议通知本地网络上的路由器关于要接收发送给某个组播的分组的愿望。

&emsp;&emsp;**组播只发送一份数据**，只有数据在传送路径出现分岔时才将分组复制后继续转发。组播需要路由器的支持才能实现，能够运行组播协议的路由器称为**组播路由器**。

<img src="./计算机网络/4.6.1-1.png" alt="4.6.1-1" style="zoom:80%;" />

#### 4.6.2 IP组播地址

&emsp;&emsp;**IP组播使用D类地址格式**。D类地址的前四位是**1110**，因此D类地址范围是**224.0.0.0~239.255.255.255**。每个D类IP地址标志一个组播组。

&emsp;&emsp;组播数据报和一般的数据报的区别是，前者使用D类IP地址作为目的地址，并且**首部中的协议字段值是2，表明使用IGMP**。

<img src="./计算机网络/4.6.2-1.png" alt="4.6.2-1" style="zoom:80%;" />

&emsp;&emsp;IP组播可以分为两种：一种**只在本局域网上进行硬件组播**；另一种则**在因特网的范围内进行组播**。

&emsp;&emsp;IANA拥有的以太网组播地址的范围是从**01-00-5E-00-00-00到01-00-5E-7F-FF**。不难看出。在每个地址中，**只有23位可用作组播**。

<img src="./计算机网络/4.6.2-2.png" alt="4.6.2-2" style="zoom:80%;" />

- **例子**

<img src="./计算机网络/4.6.2-3.png" alt="4.6.2-3" style="zoom:80%;" />

#### 4.6.3 IGMP与组播路由算法

&emsp;&emsp;要使路由器知道组播成员的信息，需要利用**因特网组管理协议(Internet Group Management Protocol, IGMP)**。连接到局域网上的组播路由器还必须和因特网上的其他组播路由器协同工作，以便把组播数据报用最小代价传送给所有组成员，这就需要使用组播路由选择协议。

&emsp;&emsp;IGMP应视为TCP/IP的一部分，其工作可分为两个阶段：

<img src="./计算机网络/4.6.3-1.png" alt="4.6.3-1" style="zoom:80%;" />

&emsp;&emsp;组播路由选择实际上就是要找出**源主机为根结点的组播转发树**，其中**每个分组在每条链路上只传送一次**(即在**组播转发树上的路由器不会收到重复的组播数据报**)。不同的多播组对应于不同的多播转发树；同一个多播树，对不同的源点也会有不同的多播转发树。

&emsp;&emsp;在许多路由器互联的支持硬件多点传送的网络上实现因特网组播时，主要有三种路由算法：

1）基于链路状态的路由选择

2）基于距离-向量的路由选择

3）建立在任何路由协议上，因此成为协议无关的组播(PIM)



### 4.7 移动IP



### 4.8 网络层设备

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2016-33</font>

#### 4.8.1 路由器的组成和功能

**（1）组成**

&emsp;&emsp;路由器是一个具有**多个输入/输出端口**的专用计算机。从结构上看，路由器由**路由选择**和**分组转发**两部分构成的。从模型的角度看，路由器是**网络层设备**，它实现了网络模型的下三层，即物理层、数据链路层和网络层。

<img src="./计算机网络/4.8.1-1.png" alt="4.8.1-1" style="zoom:80%;" />

- **路由选择部分**

&emsp;&emsp;也称为控制部分，其**核心构件是路由选择处理机**。路由选择处理机的任务是**根据所选定的路由协议构造出路由表**，同时经常或定期地和其他相邻路由器交换路由信息而不断更新和维护路由表。

- **分组转发部分：输入/输出端口、交换结构**

**1）输入/输出端口**：输入端口从物理层接收到的比特流中提取出链路层帧，进而从帧中提取出网络层数据报，输出端口则执行相反的操作。

**2）交换结构**：是路由器的关键部件，它根据转发表对分组进行处理，将某个输入端口进入的分组从一个合适的输出端口转发出去。有三种常见的交换方法：

**① 存储器进行交换	② 总线进行交换	③ 互联网络进行交换**

**【注】**：交换结构本身就是一个网络。



**（2）功能**

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2010-38,2012-37</font>

1）**连接不同的网络(连接异构网络)**并完成路由转发。

2）在多个逻辑网络(即多个广播域)互联时必须使用路由器。即**路由器既可以隔离冲突域，也可以隔离广播域**。

3）路由器可以作为最基础的**包过滤防火墙应用**。

4）运行路由协议、设备路由表。

5）**检测到拥塞时，可合理丢弃IP分组**，并向发出该IP分组的源主机发送一个源点抑制的ICMP报文。

6）对接收到IP分组的首部**进行差错检验，丢弃差错首部的报文**，但**不保证IP分组不丢失**。

**【注】**：最主要的两个功能 **① 分组转发	② 路由计算**



**（3）路由器和网桥的区别**

&emsp;&emsp;**网桥与高层协议无关，而路由器是面向协议的**，它依据网络地址进行操作，并进行路径选择、分段、帧格式转换、对数据报的生存时间和流量进行控制等。

&emsp;&emsp;路由器支持的协议有：**OSI、TCP/IP、IPX**等。



#### 4.8.2 路由表与路由转发

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2015-38</font>

<font color='#0099ff' size=5 face="黑体">大题：</font><font color='#FF0000' size=4 face="黑体">2009-47,2013-47,2014-47</font>

**（1）路由表**

&emsp;&emsp;路由表是根据路由选择算法得出的，主要用途是路由选择。标准的路由表有4个项目：

**① 目的网络IP地址	②子网掩码	③下一跳IP地址	④ 接口**

- **例子**

<img src="./计算机网络/4.8.2-1.png" alt="4.8.2-1" style="zoom:80%;" />

<img src="./计算机网络/4.8.2-2.png" alt="4.8.2-2" style="zoom:80%;" />

**【注】**到互联网的路由实际上相当于一个默认路由，**默认路由**一般写作0/0，即目的地址为0.0.0.0，子网掩码为255.255.255.255。



**（2）转发表**

&emsp;&emsp;转发表示从路由表得出的，其表项和路由表项有直接对应关系。但转发表的格式和路由器的格式不同，其结构应**使查找最优化(而路由表则需对网络拓扑变化的计算最优化)**。

&emsp;&emsp;转发表中含有一个分组将**要发往的目的地址**，以及**分组的下一跳(即下一步接受者的目的地址，实际为MAC地址)**。为了减少转发表的重复项目，可以使用一个默认路由器代替所有具有相同“下一跳”的项目，并将默认路由设置得比其他项目的优先级低，如上例。

**【注】**：路由表总是用软件来实现的；转发表可以用软件来实现，甚至也可以用特殊的硬件来实现。





## 第5章 传输层



### 5.2 UDP协议

####5.2.1 UDP数据报

<font color='#0099ff' size=5 face="黑体">考点：</font><font color='#FF0000' size=4 face="黑体">2014-39</font>

1. **UDP概述**

&emsp;&emsp;RFC 768定义的UDP只是在IP的数据报服务上增加了两个最基本的服务：**复用和分用**以及**差错检测**。UDP的优点如下：

1）UDP**无须建立连接**。

2）无连接状态。

3）分组首部开销小。TCP有20B的首部开销，而UDP仅有8B的开销。

4）应用层能更好地控制要发送的数据和发送时间。**UDP没有拥塞控制**，因此网络中的拥塞不会影响主机的发送效率。

【注】

- UDP常用于一次性传输较少数据的网络应用，如**DNS**、**SNMP**等。
- **UDP提供尽最大努力交付，即不保证可靠交付**。
- **UDP是面向报文的**。发送方UDP对应用层交下来的报文，在添加首部后就向下交付给IP层，既不合并也不拆分。接收方UDP对IP层交上来的UDP用户数据，在去除首部后就原封不动地交付给上层的应用进程，一次交付一个完整的报文。因此报文不可分割，是UDP数据处理的最小单位。

2. **UDP的首部格式**

&emsp;&emsp;UDP数据报包含两个部分：UDP首部和用户数据。

<img src="./计算机网络/5.2.1-1.png" alt="5.2.1-1" style="zoom:90%;" />

（1）**源端口**：源端口号。需要对方回信时选用，不需要时可用全0。

（2）**目的端口**：目的端口号。这在终点交付报文时必须用到。

（3）**长度**：UDP数据报的长度(包括首部和数据)，其最小值是8(仅有首部)。

（4）**校验和**：检测UDP数据报在传输中是否有错。有错就丢弃。该字段是可选的，当源主机不想计算校验和时，则直接令该字段全0。

#### 5.2.2 UDP校验

&emsp;&emsp;在计算校验和时，**要在UDP数据报之前增加12B的伪首部，伪首部并不是UDP的真正首部**。伪首部既不向下传送也不向上递交，而仅为了计算校验和，既检查了**UDP数据报**，又对**IP数据报的源IP地址**和**目的IP地址**进行了检验。

<img src="./计算机网络/5.2.2-1.png" alt="5.2.2-1" style="zoom:85%;" />

&emsp;&emsp;UDP校验和的计算方法使用**二进制反码运算求和再取反**。

**【注】IP数据报的校验和只检查数据报的首部，但UDP的校验和则检查首部和数据部分**。



### 5.3 TCP协议

<font color='#0099ff' size=5 face="黑体">大题：</font><font color='#FF0000' size=4 face="黑体">2016-41</font>

#### 5.3.1 TCP协议的特点

（1）TCP是**面向连接**的传输层协议。

（2）每条TCP连接只能是两个端点，即**点对点(一对一)**。

（3）TCP提供**可靠**的交付服务，保证传送数据**无差错**、**不丢失**、**不重复**且**有序**。

（4）TCP提供全双工通信，允许通信双方的应用进程在任何时候都能发送数据，为此TCP连接的两端设有**发送缓存**和**接收缓存**，用来临时存放双向通信的数据。

- **发送缓存**

① 发送应用程序传送给发送方TCP准备发送的数据

② TCP已发送但尚未收到确认的数据

- **接收缓存**

① 按序到达但尚未被接收应用程序读取的数据

② 不按序到达的数据

（5）TCP是面向**字节流**的，虽然应用程序和TCP的交互是一次一个数据块(大小不等)，但TCP把应用程序交下来的数据仅视为一连串的无结构字节流。

#### 5.3.2 TCP报文段

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2009-38,2010-39,2011-40,2013-39</font>

<font color='#0099ff' size=5 face="黑体">大题：</font><font color='#FF0000' size=4 face="黑体">2012-47</font>

&emsp;&emsp;TCP传送的数据单元称为报文段，一个TCP报文段分为**TCP首部**和**TCP数据**两部分，整个TCP段作为IP数据报的数据部分分封在IP数据报中。**TCP报文段的首部最短为20B**，后面有4N字节是根据需要而增加的选项，通常为4B的整数倍。

<img src="./计算机网络/5.3.2-1.png" alt="5.3.2-1" style="zoom:95%;" />

各字段意义如下：

（1）**源端口和目的端口**：各占2B。**端口是传输层与应用层的服务接口**，运输层的复用和分用功能都要通过端口实现。

（2）**序号字段(seq)**：占4B。TCP是面向字节流的(即TCP传送时是逐个字节传送的)，因此TCP传送的数据流中每个字节都编上一个序号。序号的字段是指**本报文段发送数据的第一个字节序号**。

> 例如：一个报文段的序号是301，而携带的数据共有100B，表明本报文段的数据的最后一个字节的序号是400，故下一个报文段的数据序号应从401开始。

例子2：

<img src="./计算机网络/5.3.2-2.png" alt="5.3.2-2" style="zoom:80%;" />

（3）**确认号字段(ack)**：占4B，是**期望收到对方的下一个报文段的数据的第一个字节的序号**。若确认号为$N$，则表明序号到$N-1$为止的所有数据已经正确收到。

> 例如：B正确收到了A发送过来的一个报文段，其序号为501，而数据长度为200B(序号为501~700)，这表明B正确接收到了A发送的到序号700为止的数据。因此B期望收到A的下一个数据序号是701，于是B在发送给A的确认报文段中把确认号置为701。

（4）**数据偏移(即首部长度)**：占4位，这里不是IP数据报分片的那个数据偏移，而是表示首部长度，它指出TCP报文段的数据起始处距离TCP报文段的起始处有多远。单位是**32位(4B)**，当**字段为15时**达到TCP首部的**最大长度60B**。

（5）**保留字段**：占6位，保留今后使用，但目前置为0，该字段可以忽略不计。

（6）**紧急位URG**：URG=1时，表明紧急指针字段有效。它告诉系统有紧急数据，应尽快传送(相当于高优先级的数据)。但URG需要和紧急指针配套使用，即数据从第一个字节到紧急指针所指字节就是紧急数据。

（7）**确认位ACK**：只有**当ACK=1时确认号字段才有效**。当ACK=0时，确认号失效。TCP规定，在连接建立后所有传送的报文段都必须把ACK置为1。

（8）**推送位PSH(Push)**：接收TCP收到PSH=1的报文段，就尽快地交付给接收应用进程，而不再等待整个缓存都填满后再向上交付。

（9）**复位位RST(Reset)**：RST=1时，表明TCP连接中**出现严重差错**，必须释放连接，然后再重新建立运算连接。

（10）**同步位SYN**：同步SYN=1表明这是一个**连接请求**或**连接接收报文**。当SYN=1，ACK=0时表明这是一个连接请求报文，对方若同意连接，则在响应报文中使用SYN=1，ACK=1。

（11）**终止位FIN(Finish)**：用来释放一个连接。**FIN=1表明此报文段的发送方的数据已发送完毕，并要求释放传输连接。**

（12）**窗口字段**：占2B，它指出允许发送的数据量，单位为**字节**。

> 设确认号是701，窗口字段是1000,。这表明，从701号算起，发送此报文段的一方还有接收1000B数据(字节序号为701~1700)的接收缓存空间。

（13）**校验和**：占2B。校验和字段校验的范围包括**首部**和**数据**两部分。在计算校验和时，和UDP一样，要**在TCP报文段的前面加上12B的伪首部(只需要将UDP伪首部的第4个字节段，即协议字段的17改为6，其他的和UDP一样)**。

（14）**紧急指针字段**：占16位，**指出在本报文段中紧急数据共有多少个字节(紧急数据放在本报文段数据的最前面)**。

（15）**选项字段**：长度可变，TCP最初只规定了一种选项，即最大报文段长度(MSS)。MSS是TCP报文段中的数据字段的最大长度。

（16）**填充字段**：这是为了使整个首部长度是4B的整数倍。



#### 5.3.3 TCP连接管理

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2011-39</font>

&emsp;&emsp;TCP是**面向连接**的协议，每个TCP连接都要三个阶段：**连接建立**、**数据传输**和**连接释放**。TCP连接采用**客户/服务器方式**。

1. **TCP连接的建立**

<img src="./计算机网络/5.3.3-1.png" alt="5.3.3-1" style="zoom:80%;" />

2. **TCP连接的释放**

<img src="./计算机网络/5.3.3-2.png" alt="5.3.3-2" style="zoom:85%;" />

对上述TCP连接建立和释放的总结如下：<img src="./计算机网络/5.3.3-3.png" alt="5.3.3-3" style="zoom:75%;" />

#### 5.3.4 TCP可靠传输

1. **序号**

&emsp;&emsp;TCP首部的序号字段用来保证数据能有序提交给应用层，TCP把数据视为一个**无结构**但**有序**的**字节流**，序号建立在传送的字节流上，而不建立在报文段上。

2. **确认**

TCP默认使用累计确认，即TCP只确认数据流中至第一个丢失字节为止的字节。

> 例如，接收方B接收了A发送的包含字节0~2及字节6~7的报文段。这时B到A的下一个报文段将确认号字段置为3。

3. **重传**

有两种事件会导致TCP对报文段进行重传：**超时**和**冗余ACK**。

**（1）超时**

&emsp;&emsp;TCP每发送一个报文段，就对这个报文段设置一次计时器。计时器设置的重传时间到期但未收到确认时，就重传这一报文段。

&emsp;&emsp;TCP采用一种自适应算法，它记录一个报文的发出时间，以及收到相应确认的时间，这两个时间之差称为**报文段的往返时间(RTT)**。

**（2）冗余ACK**

&emsp;&emsp;发送方A发送了1、2、3、4、5的TCP报文段，其中2号报文段在链路中丢失，它无法到达接收方B。因此3、4、5号报文段对于B来说就成了失序报文段。

#### 5.3.5 TCP流量控制

&emsp;&emsp;流量控制是一种**速度匹配服务(匹配发送方的发送速率与接收方的读取速率)**。TCP提供一种基于滑动窗口协议的流量控制机制。

&emsp;&emsp;在通信过程中，接收方根据自己接收缓存的大小，动态地调整发送方的发送窗口大小，这称为**接收窗口(rwnd)**。即调整TCP报文段首部中的“窗口”字段值，来限制发送方向网络注入报文的速率。同时，发送方根据其对当前网络拥塞程序的估计而确定的窗口值，称为**拥塞窗口**。

<img src="./计算机网络/5.3.5-1.png" alt="5.3.5-1" style="zoom:80%;" />

- **传输层和数据链路层的流量控制区别**

（1）传输层定义端到端用户之间的流量控制，数据链路层定义两个中间的相邻结点的流量控制。

（2）数据链路层的滑动窗口大小不能动态改变，传输层的则可以动态改变。

#### 5.3.6 TCP拥塞控制

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2009-39,2014-38,2015-39,2017-39</font>

&emsp;&emsp;所谓拥塞控制，就是防止过多的数据注入网络，以使网络中的路由器或链路不致过载。因特网提供了4种拥塞算法：**慢开始**、**拥塞避免**、**快重传**、**快恢复**。

- **TCP协议要求维护以下两个窗口**

（1）**接收窗口rwnd**：接收方根据目前接收缓存大小所许诺的最新窗口值，**反映接收方的容量**。

（2）**拥塞窗口cwnd**：发送方根据自己估算的网络拥塞程度而设置的窗口值，**反映网络的容量**。
$$
发送窗口的上限值=\min\{rwnd,cwnd\}
$$

- **拥塞控制和流量控制的区别**

&emsp;&emsp;拥塞控制是让网络能够承受现有的网络负荷，是一个全局性的过程，涉及所有的主机、所有的路由器，以及与降低网络传输性能有关的所有因素。相反，流量控制往往是指点到点的通信量控制，即接收端控制发送端，抑制发送数据的速率，以便使接收端来得及接收。



1. **慢开始和拥塞避免**

**（1）慢开始算法**

&emsp;&emsp;在TCP刚刚连接好并开始发送TCP报文段时，**先令cwnd=1**，即一个最大报文段长度MSS。每收到一个对新报文的确认后，将cwnd加1，即增加一个MSS。

<img src="./计算机网络/5.3.6-1.png" alt="5.3.6-1" style="zoom:75%;" />

&emsp;&emsp;使用慢开始算法，每经过一次传输轮次(即往返RTT)，拥塞窗口cwnd就会加倍，即cwnd的大小指数式增长。慢开始一直把拥塞窗口cwnd增大到一个规定的慢开始门限**ssthresh(阈值)**，然后改用拥塞避免算法。

**（2）拥塞避免算法**

&emsp;&emsp;发送端的拥塞窗口cwnd每经过一个往返时延RTT就增加一个MSS的大小，而不是加倍，使cwnd按线性规律缓慢增长(加法增大)，而**当出现一次超时时(网络拥塞)时，令慢开始门限ssthresh等于当前cwnd的一半(乘法减少)**。

<img src="./计算机网络/5.3.6-2.png" alt="5.3.6-2" style="zoom:85%;" />

**（3）网络拥塞的处理**

&emsp;&emsp;网络出现拥塞时，无论是在慢开始阶段还是拥塞避免阶段，**只要发送方检查到超时事件发生(未按时收到确认，重传计数器超时)，就要把慢开始门限sshresh设置为出现拥塞时的一半(但不能小于2)。然后把拥塞窗口cwnd重新设置为1，执行慢开始算法**。

<img src="./计算机网络/5.3.6-3.png" alt="5.3.6-3" style="zoom:80%;" />

**【注】在慢开始(指数增长)阶段，若2cwnd > ssthresh，则下一个RTT的cwnd等于ssthresh，而不等于2cwnd，即cwnd不能越过ssthresh值。**

2. **快重传和快恢复**

**（1）快重传**

&emsp;&emsp;快重传技术使用了冗余ACK来检测丢包的发生，同样，冗余ACK也用于网络拥塞的检测。当发送方连续接收到三个重复的ACK报文时，直接重传对方尚未收到的报文段，而不必等待那个报文段设置的重传计时器超时。

**（2）快恢复**

&emsp;&emsp;发送端收到连续三个冗余ACK(即重复确认)时，执行“乘法减小”算法，把慢开始门限ssthresh设置为出现拥塞时发送方cwnd的一半。与慢开始不同的是，它把cwnd的值设置为慢开始门限ssthresh改变后的数值，然后开始执行拥塞避免算法(“加法增大”)，使拥塞窗口缓慢地线性增大。

<img src="./计算机网络/5.3.6-4.png" alt="5.3.6-4" style="zoom:90%;" />



## 第6章 应用层

### 6.2 域名系统(DNS)

&emsp;&emsp;域名系统(Domain Name System, DNS)是因特网使用的命名系统，用来把便于人们记忆的具有特定含义的主机名(如www.cskaoyan.com)**转换为便于机器处理的IP地址**。DNS系统采用**客户/服务器模型**，其**协议运行在UDP之上**，**使用53号端口**。

#### 6.2.1 层次域名空间

&emsp;&emsp;因特网采用**层次树结构**的命名方法。采用这种命名方法，任何一个连接到因特网的主机或者路由器，都有一个唯一的层次结构名称，即**域名(Domain Name)**。域(Domain)是名字空间中一个可被管理的划分。**域还可以分为子域，而子域还可以继续划分为子域的子域，这样就形成了顶级域、二级域、三级域等**。每个域名都由**标号序列**组成，而标号之间用(".")隔开。一个典型的例子如图：

<img src="./计算机网络/6.2.1-1.png" alt="6.2.1-1" style="zoom:80%;" />

- **使用域名中的标号有几点需要注意**

<img src="./计算机网络/6.2.1-2.png" alt="6.2.1-2" style="zoom:80%;" />

- **顶级域名(Top Level Domain, TLD)分如下三类：**

<img src="./计算机网络/6.2.1-3.png" alt="6.2.1-3" style="zoom:80%;" />

【注】**国家顶级域名下注册的二级域名均由国家自行确定**。

<img src="./计算机网络/6.2.1-4.png" alt="6.2.1-4" style="zoom:80%;" />

#### 6.2.2 域名服务器

&emsp;&emsp;**域名到IP地址的解析是由运行在域名服务器上的程序完成的**，一个服务器所负责管辖的(或有权限的)范围称为**区**(不以“域”为单位)，各单位根据具体情况划分自己管辖范围的区，但在一个区中的所有结点必须是能够相互连通的，每个区设置相应的权限域名服务器，用来保存该区中的所有主机的域名到IP地址的映射。每个域名服务器不仅能够进行一些域名到IP地址的解析，而且还必须有连向其他域名服务器的信息。当自己不能进行域名到IP地址的转换时，能够知道到什么地方去找其他域名服务器。

&emsp;&emsp;采用分布式设计的DNS，是一个在因特网上实现分布式数据库的精彩范例。主要有4种域名服务器。

1. **根域名服务器**

<img src="./计算机网络/6.2.2-1.png" alt="6.2.2-1" style="zoom:80%;" />

2. **顶级域名服务器**

<img src="./计算机网络/6.2.2-2.png" alt="6.2.2-1" style="zoom:80%;" />

3. **授权域名服务器**

<img src="./计算机网络/6.2.2-3.png" alt="6.2.2-1" style="zoom:80%;" />

4. **本地域名服务器**

<img src="./计算机网络/6.2.2-4.png" alt="6.2.2-1" style="zoom:80%;" />

- **DNS的层次结构**

<img src="./计算机网络/6.2.2-5.png" alt="6.2.2-1" style="zoom:80%;" />



#### 6.2.3 域名解析过程

<font color='#0099ff' size=5 face="黑体">考点：</font><font color='#FF0000' size=4 face="黑体">2010-40,2016-40</font>

&emsp;&emsp;域名解析是把域名映射成IP地址或把IP地址映射成域名的过程。前者称为**正向解析**，后者称为**反向解析**。域名解析有两种方式：**递归查询**和**递归与迭代相结合的查询**。

<img src="./计算机网络/6.2.3-1.png" alt="6.2.3-1" style="zoom:90%;" />

&emsp;&emsp;为了提高DNS的查询效率，使用了**高速缓存**。客户机在向本地域名服务器发送DNS请求报文时，本地域名服务器接收到请求后先查询本地缓存，若没有，则再根据上述两种域名解析的方式进行查询。

**【注】**域名服务器完成域名解析的过程，最多发出的DNS查询次数是4次，最少是0次。



### 6.3 文件传输协议(FTP)

#### 6.3.1 FTP的工作原理

&emsp;&emsp;文件传输协议(File Transfer Protocol, FTP)是**因特网上使用得最广泛的文件传输协议**。FTP提供交互式的访问，允许客户指明文件的类型与格式，并允许文件具有存取格式。

- **FTP的功能**

① 提供不同类主机系统(硬、软件体系都可以不同)之间的文件传输能力。

② 以用户权限管理的方式提供用户对远程FTP服务器上的文件管理能力。

③ 以匿名FTP的方式提供公用文件共享的能力。

- **工作步骤**

① 打开**熟知端口21(控制端口)**，使客户进程能够连接上。

② 等待客户进程发连接请求。

③ 启动从属进程来处理客户进程发来的请求。主进程与从属进程并发执行，从属进程对客户进程的请求处理完毕后即终止。

④ 回到等待状态，继续接收其他客户进程的请求。

#### 6.3.2 控制连接与数据连接

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2009-40,2017-40</font>

&emsp;&emsp;FTP在工作时使用两个并行的TCP连接：一个是**控制连接(端口21)**，一个是**数据连接(端口20)**。使用两个不同的端口号可使协议更加简单和更容易实现。

**【注】**默认情况下FTP使用TCP 20 端口建立数据连接，但**是否使用TCP 20 端口建立数据连接与传输模式有关**，主动方式使用TCP 20 端口，被动方式由服务器和客户端自行协商决定。

<img src="./计算机网络/6.3.2-1.png" alt="6.3.2-1" style="zoom:80%;" />

1. **控制连接**

&emsp;&emsp;**服务器监听21号端口，等待客户连接**，建立在这个端口上的连接称为控制连接。控制连接用来传输控制信息(如**连接请求**、**传送请求**等)，并且**控制信息都以7位ASCII格式传送**。**控制连接在整个会话期间一直保持打开状态**。

2. **数据连接**

&emsp;&emsp;服务器的控制进程在接收到FTP客户发来的文件传输请求后，就创建**“数据传送进程”**和**“数据连接”**。数据连接用来连接客户端和服务器的数据传送进程，**数据传送进程实际完成文件的传送**，在传送完毕后关闭“数据传送连接”并结束运行。



### 6.4 电子邮件

#### 6.4.1 电子邮件系统的组成结构

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2012-40,2013-40,2014-40,2015-33</font>

<img src="./计算机网络/6.4.1-1.png" alt="6.4.1-1" style="zoom:75%;" />

- **用户代理(UA)**：用户与电子邮件系统的接口。用户代理就是一个运行在PC上的程序，常见的有Outlook、Foxmail和Thunderbird等。
- **邮件服务器**：组成电子邮件系统的核心。邮件服务器的功能是发送和接收邮件，同时还要向发信人报告邮件传送的情况(已交付、被拒绝、丢失等)。邮件服务器采用**客户/服务器方式**工作，但它能同时充当客户和服务器。
- **邮件发送协议和读取协议**：SMTP 采用“推”的通信方式，用于用户代理向邮件服务器发送邮件、以及邮件服务器之间发送邮
  件。POP3 采用“拉”的通信方式，用于用户从目的邮件服务器上读取邮件。

- **邮件的收发过程**

<img src="./计算机网络/6.4.1-2.png" alt="6.4.1-2" style="zoom:80%;" />

#### 6.4.2 电子邮件与MIME

1. **电子邮件格式**

&emsp;&emsp;一个电子邮件分为信封和内容两大部分，邮件内容又分为**首部**和**主体**两部分。**RFC 822规定了邮件的首部格式**，而**邮件的主体部分则由用户自由撰写**。

&emsp;&emsp;邮件内容的首部包含一些行，每个首部行由一个关键字后跟冒号再跟值组成。有些关键字是**必须的(From和To)**，有些是**可选的(Subject)**。

- **From**：由邮件系统自动填写
- **To**：后面填写一个或多个收件人的电子邮件地址
- **Subject**：邮件的主题，反映邮件的主要内容

<img src="./计算机网络/6.4.1-3.png" alt="6.4.1-3" style="zoom:80%;" />

2. **多用途网际邮件扩充(MIME)**

&emsp;&emsp;由于**SMTP只能传送一定长度的ASCII码**，许多其他非英语国家的文字(如中文、俄文甚至带重音符的法文或德文)就无法传送，且无法传送可执行文件及其他二进制对象，因此提出了**多用途网络邮件扩充(Multipurpose Internet Mail Extensions, MIME)**。

&emsp;&emsp;MIME并未改动SMTP或取代它。MIME的意图是继续使用目前的格式，但增加了邮件主体的结构，并定义了传送非ASCII码的编制规则。即MIME邮件可以在现有的电子邮件程序和协议下传送。

- **MIME包含以下三部分**

<img src="./计算机网络/6.4.1-4.png" alt="6.4.1-4" style="zoom:80%;" />

- **MIME与SMTP的关系**

<img src="./计算机网络/6.4.1-5.png" alt="6.4.1-5" style="zoom:80%;" />



### 6.5 万维网(WWW)

#### 6.5.1 WWW的概念与组成结构

&emsp;&emsp;万维网(World Wide Web, WWW)是一个资料空间，在这个空间中，一样有用的事物称为一样的“资源”，并由一个**全域“统一定位符”(URL)**标识。这些资源通过**超文本传输协议(HTTP)**传送给使用者，而后者通过单击链接来获取资源。

&emsp;&emsp;**超文本标记语言(HyperText Markup Language，HTML)**使得万维网页面设计者可以很方便地用一个**超链接**从本页面的某处链接到因特网上的任何一个万维网页面，并能够在自己的计算机屏幕上显示这些页面。

- **万维网的内核部分**

<img src="./计算机网络/6.5.1-1.png" alt="6.5.1-1" style="zoom:80%;" />

- **统一定位符URL**

&emsp;&emsp;URL是对可以从因特网上得到的资源的位置和访问方法的一种简洁表示。URL相当于一个文件名在网络范围的扩展。

&emsp;&emsp;URL的一般形式是：**<协议>://<主机>:<端口>/<路径>**

① 常见的<协议>有http,ftp等；② <主机>是存放资源的主机在因特网中的**域名**，也可是**IP地址**

③ <端口>和<路径>有时可以省略。**在URL中不区分大小写**。

&emsp;&emsp;万维网以**客户端/服务器**方式工作。**浏览器是在用户计算机上的万维网客户程序，而万维网文档所驻留的计算机则运行服务器程序**，这台计算机称为万维网服务器。客户程序向服务器程序发出请求，服务器程序向客户程序送回客户所要的文档。工作流程如下：

<img src="./计算机网络/6.5.1-2.png" alt="6.5.1-2" style="zoom:80%;" />

#### 6.5.2 超文本传输协议(HTTP)

&emsp;&emsp;HTTP定义了浏览器(万维网客户进程)怎样向万维网服务器请求万维网文档，以及服务器怎样把文档传送给浏览器。从层次的角度看，**HTTP是面向事务的应用层协议**，它规定了在浏览器和服务器之间的请求和相应的格式与规则，是万维网上能可靠地交换文件(包括文本、声音、图像等各种多媒体文件)的重要基础。



3. **HTTP的报文格式**

<font color='#0099ff' size=5 face="黑体">选择：</font><font color='#FF0000' size=4 face="黑体">2015-40</font>

&emsp;&emsp;**HTTP是面向文本的(Text-Oriented)**，因此报文中的每个字段都是一些ASCII码串，并且每个字段的长度都是不确定的。有两类HTTP报文：

- **请求报文**：从客户向服务器发送的请求报文
- **响应报文**：从服务器到客户的回答

<img src="./计算机网络/6.5.2-1.png" alt="6.5.2-1" style="zoom:80%;" />

- **开始行**：用于区分请求报文还是响应报文。在请求报文中的开始行称为**请求行**，而在响应报文中的开始行称为**状态行**。开始行的三个字段之间都以空格分隔，最后的**“CR”和“LF”分别代表”回车“和”换行“**。

**（1）请求行**：方法、请求资源的URL、HTTP的版本

HTTP请求报文中常用的几个方法：

<img src="./计算机网络/6.5.2-2.png" alt="6.5.2-2" style="zoom:80%;" />

**connect**：close表示非持续连接方式，keep-alive表示持续连接方式

- **首部行**：用来说明**浏览器、服务器(曾经访问过)或报文主体的一些信息**。首部可以有几行，但可不使用。每行结束都要有“回车”和“换行”。

- **实体主体**：在请求报文中一般不用这个字段，而在响应报文中也可能没有这个字段。



